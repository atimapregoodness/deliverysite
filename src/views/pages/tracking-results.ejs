<%- layout('layouts/main') %>
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --primary-color: #667eea;
    --primary-light: #f7f9ff;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
    --light-bg: #f8fafc;
    --card-bg: #ffffff;
    --text-dark: #1e293b;
    --text-muted: #64748b;
    --border-color: #e2e8f0;
  }

  body {
    background-color: #f1f5f9;
    color: var(--text-dark);
    font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .tracking-header {
    background: var(--primary-gradient);
    color: white;
    border-radius: 0 0 24px 24px;
    padding: 2rem 0;
    margin-bottom: 2rem;
    box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
  }

  .modern-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
    overflow: hidden;
  }

  .modern-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
      0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }

  .card-header-modern {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
  }

  .card-body-modern {
    padding: 1.5rem;
  }

  .status-badge {
    padding: 0.5rem 1.25rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .status-pending {
    background: #fef3c7;
    color: #92400e;
  }
  .status-in_transit {
    background: #dbeafe;
    color: #1e40af;
  }
  .status-delayed {
    background: #fee2e2;
    color: #991b1b;
  }
  .status-delivered {
    background: #d1fae5;
    color: #065f46;
  }
  .status-cancelled {
    background: #f3f4f6;
    color: #374151;
  }

  .map-container-modern {
    height: 400px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    border: 1px solid var(--border-color);
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .info-item {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
  }

  .info-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
  }

  .info-value {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-dark);
  }

  .progress-track {
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
    margin: 1.5rem 0;
    position: relative;
  }

  .progress-fill {
    height: 100%;
    background: var(--primary-gradient);
    border-radius: 4px;
    position: relative;
    transition: width 0.5s ease;
  }

  .timeline-modern {
    position: relative;
    padding-left: 2rem;
  }

  .timeline-modern::before {
    content: "";
    position: absolute;
    left: 11px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, var(--primary-color), #c7d2fe);
  }

  .timeline-item-modern {
    position: relative;
    margin-bottom: 1.25rem;
    padding: 1.25rem;
    background: white;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .timeline-item-modern::before {
    content: "";
    position: absolute;
    left: -1.5rem;
    top: 1.5rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-color);
    border: 3px solid white;
    box-shadow: 0 0 0 2px var(--primary-color);
  }

  .timeline-item-modern.completed::before {
    background: var(--success-color);
    box-shadow: 0 0 0 2px var(--success-color);
  }

  .timeline-item-modern.current::before {
    background: var(--warning-color);
    box-shadow: 0 0 0 2px var(--warning-color);
  }

  .category-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
  }

  .category-electronics {
    background: #dbeafe;
    color: #1e40af;
  }
  .category-clothing {
    background: #fce7f3;
    color: #be185d;
  }
  .category-furniture {
    background: #fef3c7;
    color: #92400e;
  }
  .category-documents {
    background: #dcfce7;
    color: #166534;
  }
  .category-food {
    background: #fef9c3;
    color: #854d0e;
  }
  .category-medical {
    background: #fee2e2;
    color: #991b1b;
  }
  .category-other {
    background: #f3f4f6;
    color: #374151;
  }

  .vehicle-marker {
    width: 48px;
    height: 48px;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    border: 3px solid white;
  }

  .stats-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
  }

  .stats-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
    line-height: 1;
  }

  .stats-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
  }

  .incidents-scrollable {
    max-height: 400px;
    overflow-y: auto;
    padding-right: 10px;
  }

  .incidents-scrollable::-webkit-scrollbar {
    width: 6px;
  }

  .incidents-scrollable::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
  }

  .incidents-scrollable::-webkit-scrollbar-thumb {
    background: var(--primary-color);
    border-radius: 3px;
  }

  .collapsible-section {
    margin-bottom: 1rem;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .collapsible-header {
    padding: 1.25rem;
    background: #f8fafc;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
  }

  .collapsible-header:hover {
    background: #f1f5f9;
  }

  .collapsible-content {
    padding: 1.25rem;
    background: white;
    display: none;
    border-top: 1px solid var(--border-color);
  }

  .collapsible-content.show {
    display: block;
  }

  .btn-modern {
    padding: 0.625rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    border: none;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-modern-primary {
    background: var(--primary-gradient);
    color: white;
  }

  .btn-modern-outline {
    background: transparent;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
  }

  .btn-modern-outline:hover {
    background: var(--primary-color);
    color: white;
  }

  .eta-card {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 1.25rem;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .eta-time {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    line-height: 1;
  }

  .eta-label {
    font-size: 0.875rem;
    color: rgba(255, 255, 255, 0.9);
    margin-top: 0.5rem;
  }

  @media (max-width: 768px) {
    .info-grid {
      grid-template-columns: 1fr;
    }
    .timeline-modern {
      padding-left: 1.5rem;
    }
  }

  .progress-container {
    height: 40px;
    position: relative;
  }

  .arrow-container {
    position: absolute;
    transform: translateX(-50%);
    top: -4px;
    z-index: 5;
  }

  .arrow {
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 10px solid #e2e8f0;
    transition: all 0.3s ease;
  }

  .arrow.active {
    border-top-color: var(--primary-color);
    filter: drop-shadow(0 2px 4px rgba(102, 126, 234, 0.3));
  }

  .stage-indicator {
    flex: 1;
  }

  .stage-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e2e8f0;
    color: #94a3b8;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    margin: 0 auto;
    transition: all 0.3s ease;
    position: relative;
    border: 2px solid transparent;
  }

  .stage-circle.completed {
    background: var(--primary-gradient);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
    border-color: white;
  }

  .stage-circle.current {
    background: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    animation: pulse 2s infinite;
  }

  .stage-label {
    font-size: 0.75rem;
    letter-spacing: 0.025em;
    transition: all 0.3s ease;
  }

  .stage-percentage {
    font-size: 0.7rem;
    opacity: 0.8;
  }

  @keyframes pulse {
    0%,
    100% {
      transform: scale(1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    }
    50% {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
    }
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .stage-label {
      font-size: 0.7rem;
    }

    .stage-circle {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }
  }
</style>

<!-- Header Section -->
<div class="tracking-header">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h2 fw-bold mb-2">Package Tracking</h1>
        <div class="d-flex align-items-center flex-wrap gap-3">
          <div
            class="status-badge status-<%= package.status.replace('_', '-') %>"
          >
            <i
              class="fas <%= { 'pending': 'fa-clock', 'in_transit': 'fa-truck-moving', 'delayed': 'fa-exclamation-triangle', 'delivered': 'fa-check-circle', 'cancelled': 'fa-times-circle' }[package.status] %>"
            ></i>
            <%= package.status.replace('_', ' ').toUpperCase() %>
          </div>
          <div class="text-light opacity-90">
            <i class="fas fa-box me-1"></i> <%= package.trackingId %>
          </div>
          <% if(package.isOverdue) { %>
          <div class="text-warning">
            <i class="fas fa-exclamation-triangle me-1"></i> OVERDUE
          </div>
          <% } %>
        </div>
      </div>
      <div class="col-md-4 text-md-end">
        <div class="eta-card mt-3">
          <div class="eta-time">
            <% if(package.estimatedDelivery) { %> <%= new
            Date(package.estimatedDelivery).toLocaleTimeString([], {hour:
            '2-digit', minute:'2-digit'}) %> <% } else { %> N/A <% } %>
          </div>
          <div class="eta-label">Estimated Delivery</div>
          <% if(package.estimatedDelivery) { %>
          <div class="small text-white opacity-90 mt-1">
            <%= new Date(package.estimatedDelivery).toLocaleDateString('en-US',
            { weekday: 'short', month: 'short', day: 'numeric' }) %>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container py-4">
  <% if(package.delayInfo) { %>
  <div
    class="alert alert-warning alert-dismissible fade show mb-4"
    role="alert"
  >
    <div class="d-flex align-items-center">
      <i class="fas fa-clock me-3"></i>
      <div>
        <h6 class="alert-heading mb-1">Delivery Delay Alert</h6>
        <p class="mb-1">
          <strong>Reason:</strong> <%= package.delayInfo.reason %>
        </p>
        <p class="mb-1">
          <strong>Description:</strong> <%= package.delayInfo.description %>
        </p>
        <% if(package.delayInfo.estimatedDelay) { %>
        <p class="mb-0">
          <strong>Estimated Delay:</strong> <%= package.delayInfo.estimatedDelay
          %> minutes
        </p>
        <% } %>
      </div>
    </div>
  </div>
  <% } %>

  <div class="row">
    <!-- Left Column: Map & Tracking -->
    <div class="col-lg-8">
      <!-- Map Section -->
      <div class="modern-card mb-4">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-map-marked-alt me-2"></i>Live Delivery Route
          </h4>
        </div>
        <div class="card-body-modern p-0">
          <div class="p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <p class="text-muted small mb-0">
                <%= package.pickupAddress %> → <%= package.deliveryAddress %>
              </p>
              <div class="d-flex gap-2">
                <button
                  class="btn btn-modern btn-modern-outline btn-sm"
                  onclick="centerMap()"
                >
                  <i class="fas fa-crosshairs me-1"></i>Center
                </button>
                <button
                  class="btn btn-modern btn-modern-outline btn-sm"
                  onclick="toggleCheckpoints()"
                >
                  <i class="fas fa-layer-group me-1"></i>Checkpoints
                </button>
              </div>
            </div>
            <div id="map" class="map-container-modern"></div>
          </div>
        </div>
      </div>

      <!-- Progress & Stats -->
      <div class="modern-card mb-4">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-chart-line me-2"></i>Delivery Progress & Status
          </h4>
        </div>
        <div class="card-body-modern">
          <!-- Progress Bar -->
          <div class="progress-track">
            <div
              class="progress-fill"
              style="width: <%= package.trackingData?.routeProgress || 0 %>%"
            ></div>
          </div>

          <!-- Progress Stages -->
          <div class="row text-center mt-4">
            <div class="col-6 col-md-3 mb-3">
              <div class="stats-card">
                <div class="stats-value">
                  <%= package.trackingData?.routeProgress || 0 %>%
                </div>
                <div class="stats-label">Progress</div>
              </div>
            </div>

            <div class="col-6 col-md-3 mb-3">
              <div class="stats-card">
                <div class="stats-value">
                  <%= package.route?.totalDistance ?
                  (package.route.totalDistance/1000).toFixed(1) : '0' %>
                </div>
                <div class="stats-label">Distance (km)</div>
              </div>
            </div>

            <div class="col-6 col-md-3 mb-3">
              <div class="stats-card">
                <div class="stats-value">
                  <%= package.route?.totalDuration ?
                  Math.floor(package.route.totalDuration/60) : '0' %>
                </div>
                <div class="stats-label">Est. Time (min)</div>
              </div>
            </div>

            <div class="col-6 col-md-3 mb-3">
              <div class="stats-card">
                <div class="stats-value">
                  <%= package.trackingData.waypoints ?
                  package.trackingData.waypoints.filter(wp => wp.arrived).length
                  : 0 %>
                </div>
                <div class="stats-label">Checkpoints</div>
              </div>
            </div>
          </div>
          <!-- Status Indicators -->
          <% // Avoid reserved keyword "package" const pkg = delivery &&
          delivery.package ? delivery.package : {}; const currentStatus =
          pkg.status || 'pickup'; const stages = [ { key: 'pickup', label:
          'Pickup' }, { key: 'in_transit', label: 'In Transit' }, { key:
          'out_for_delivery', label: 'Out for Delivery' }, { key: 'delivered',
          label: 'Delivered' } ]; const currentIndex = stages.findIndex(function
          (s) { return s.key === currentStatus; }); %>

          <div class="delivery-progress mt-4">
            <!-- Labels -->
            <div
              class="d-flex justify-content-between mb-2 text-muted small fw-semibold"
            >
              <% stages.forEach(stage => { %>
              <div class="text-center flex-fill"><%= stage.label %></div>
              <% }) %>
            </div>

            <!-- Progress Bar -->
            <div class="position-relative progress-track">
              <!-- Active Progress -->
              <div
                class="progress-fill"
                style="
                  width: <%= ((currentIndex + 1) / stages.length) * 100 %>%;
                "
              ></div>

              <!-- Steps -->
              <div class="d-flex justify-content-between position-relative">
                <% stages.forEach((stage, i) => { const completed = i <=
                currentIndex; %>
                <div class="progress-step text-center flex-fill">
                  <div class="step-circle <%= completed ? 'completed' : '' %>">
                    <% if (completed) { %>
                    <i class="fas fa-check"></i>
                    <% } %>
                  </div>

                  <% if (i < stages.length - 1) { %>
                  <div class="step-arrow">
                    <i class="fas fa-chevron-right"></i>
                  </div>
                  <% } %>
                </div>
                <% }) %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline -->
      <div class="modern-card mb-4">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-history me-2"></i>Delivery Timeline
          </h4>
        </div>
        <div class="card-body-modern">
          <div class="timeline-modern">
            <div class="timeline-item-modern completed">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="fw-bold mb-1">Order Created</h6>
                  <p class="text-muted small mb-0">
                    Tracking ID: <%= package.trackingId %>
                  </p>
                </div>
                <div class="text-end">
                  <div class="small fw-bold">
                    <%= new Date(package.createdAt).toLocaleDateString() %>
                  </div>
                  <div class="small text-muted">
                    <%= new Date(package.createdAt).toLocaleTimeString() %>
                  </div>
                </div>
              </div>
            </div>

            <% package.trackingData.waypoints?.forEach((wp, idx) => { %>
            <div
              class="timeline-item-modern <%= wp.arrived ? 'completed' : (idx === 0 ? 'current' : '') %>"
            >
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="fw-bold mb-1"><%= wp.name %></h6>
                  <p class="text-muted small mb-0">
                    <%= wp.type.toUpperCase() %>
                  </p>
                  <% if(wp.arrived && wp.timestamp) { %>
                  <div class="small text-success mt-1">
                    <i class="fas fa-check-circle me-1"></i>Arrived
                  </div>
                  <% } %>
                </div>
                <div class="text-end">
                  <% if(wp.timestamp) { %>
                  <div class="small fw-bold">
                    <%= new Date(wp.timestamp).toLocaleDateString() %>
                  </div>
                  <div class="small text-muted">
                    <%= new Date(wp.timestamp).toLocaleTimeString() %>
                  </div>
                  <% } else { %>
                  <div class="small text-warning">Pending</div>
                  <% } %>
                </div>
              </div>
            </div>
            <% }) %>

            <!-- Only show delivered timeline item if package is delivered -->
            <% if(package.status === 'delivered') { %>
            <div class="timeline-item-modern completed">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="fw-bold mb-1">Package Delivered</h6>
                  <p class="text-muted small mb-0">
                    Successfully delivered to recipient
                  </p>
                  <% if(package.actualDelivery) { %>
                  <div class="small text-success mt-1">
                    <i class="fas fa-check-circle me-1"></i>Delivered
                  </div>
                  <% } %>
                </div>
                <div class="text-end">
                  <% if(package.actualDelivery) { %>
                  <div class="small fw-bold">
                    <%= new Date(package.actualDelivery).toLocaleDateString() %>
                  </div>
                  <div class="small text-muted">
                    <%= new Date(package.actualDelivery).toLocaleTimeString() %>
                  </div>
                  <% } else { %>
                  <div class="small text-success">Completed</div>
                  <% } %>
                </div>
              </div>
            </div>
            <% } else { %>
            <div class="timeline-item-modern">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <h6 class="fw-bold mb-1">Estimated Delivery</h6>
                  <p class="text-muted small mb-0">Expected arrival time</p>
                </div>
                <div class="text-end">
                  <div class="small fw-bold">
                    <%= new Date(package.estimatedDelivery).toLocaleDateString()
                    %>
                  </div>
                  <div class="small text-muted">
                    <%= new Date(package.estimatedDelivery).toLocaleTimeString()
                    %>
                  </div>
                </div>
              </div>
            </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Details -->
    <div class="col-lg-4">
      <!-- Package Details -->
      <div class="modern-card mb-4">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-box-open me-2"></i>Package Details
          </h4>
        </div>
        <div class="card-body-modern">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Tracking ID</div>
              <div class="info-value"><%= package.trackingId %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Category</div>
              <div class="info-value">
                <span
                  class="category-badge category-<%= package.package.category %>"
                >
                  <%= package.package.category.toUpperCase() %>
                </span>
              </div>
            </div>
            <div class="info-item">
              <div class="info-label">Weight</div>
              <div class="info-value"><%= package.package.weight %> kg</div>
            </div>
            <div class="info-item">
              <div class="info-label">Value</div>
              <div class="info-value">
                $<%= package.package.value?.toFixed(2) || '0.00' %>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <div class="info-label">Description</div>
            <div class="info-value"><%= package.package.description %></div>
          </div>

          <div class="mb-3">
            <div class="info-label">Dimensions</div>
            <div class="info-value">
              <%= package.package.dimensions?.length || 0 %> × <%=
              package.package.dimensions?.width || 0 %> × <%=
              package.package.dimensions?.height || 0 %> cm
            </div>
          </div>
        </div>
      </div>

      <!-- Sender & Receiver -->
      <div class="modern-card mb-4">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-exchange-alt me-2"></i>Sender & Receiver
          </h4>
        </div>
        <div class="card-body-modern">
          <div class="info-grid">
            <div class="info-item">
              <div class="info-label">Sender</div>
              <div class="info-value"><%= package.sender.name %></div>
              <div class="small text-muted"><%= package.sender.email %></div>
              <div class="small text-muted"><%= package.sender.phone %></div>
            </div>
            <div class="info-item">
              <div class="info-label">Receiver</div>
              <div class="info-value"><%= package.receiver.name %></div>
              <div class="small text-muted"><%= package.receiver.email %></div>
              <div class="small text-muted"><%= package.receiver.phone %></div>
            </div>
          </div>

          <div class="mt-3">
            <div class="info-label">Pickup Address</div>
            <div class="info-value"><%= package.pickupAddress %></div>
          </div>

          <div class="mt-3">
            <div class="info-label">Delivery Address</div>
            <div class="info-value"><%= package.deliveryAddress %></div>
          </div>
        </div>
      </div>

      <!-- Incidents -->
      <% if(package.incidents && package.incidents.length > 0) { %>
      <div class="modern-card mb-4">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Incidents
            <span class="badge bg-danger ms-2"
              ><%= package.incidents.length %></span
            >
          </h4>
        </div>
        <div class="card-body-modern p-0">
          <div class="incidents-scrollable p-3">
            <% package.incidents.forEach((incident, idx) => { %>
            <div class="collapsible-section">
              <div class="collapsible-header" onclick="toggleCollapse(this)">
                <div>
                  <strong><%= incident.type.toUpperCase() %></strong>
                  <span
                    class="badge <%= incident.resolved ? 'bg-success' : 'bg-warning' %> ms-2"
                  >
                    <%= incident.resolved ? 'RESOLVED' : 'ACTIVE' %>
                  </span>
                </div>
                <i class="fas fa-chevron-down"></i>
              </div>
              <div class="collapsible-content">
                <p class="small mb-2"><%= incident.description %></p>
                <div class="row g-2 small">
                  <div class="col-6">
                    <div class="text-muted">Severity</div>
                    <div class="fw-bold">
                      <%= incident.severity.toUpperCase() %>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="text-muted">Reported</div>
                    <div class="fw-bold">
                      <%= new Date(incident.reportedAt).toLocaleDateString() %>
                    </div>
                  </div>
                  <% if(incident.estimatedDelay) { %>
                  <div class="col-6">
                    <div class="text-muted">Delay</div>
                    <div class="fw-bold text-danger">
                      <%= incident.estimatedDelay %> min
                    </div>
                  </div>
                  <% } %> <% if(incident.resolvedAt) { %>
                  <div class="col-12">
                    <div class="text-muted">Resolved</div>
                    <div class="fw-bold text-success">
                      <%= new Date(incident.resolvedAt).toLocaleString() %>
                    </div>
                  </div>
                  <% } %>
                </div>
              </div>
            </div>
            <% }) %>
          </div>
        </div>
      </div>
      <% } %>

      <!-- System Info -->
      <div class="modern-card">
        <div class="card-header-modern">
          <h4 class="h5 fw-bold mb-0">
            <i class="fas fa-info-circle me-2"></i>System Information
          </h4>
        </div>
        <div class="card-body-modern">
          <div class="row g-2 small">
            <div class="col-6">
              <div class="text-muted">Created</div>
              <div class="fw-bold">
                <%= new Date(package.createdAt).toLocaleDateString() %>
              </div>
            </div>
            <div class="col-6">
              <div class="text-muted">Updated</div>
              <div class="fw-bold">
                <%= new Date(package.updatedAt).toLocaleDateString() %>
              </div>
            </div>
            <div class="col-12">
              <div class="text-muted">Tracking</div>
              <div class="fw-bold">
                <% if(package.trackingData.active) { %>
                <span class="text-success">✓ Active</span>
                <% } else { %>
                <span class="text-muted">Inactive</span>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
<script>
  const mapboxToken = "<%= mapboxToken %>";
  const packageData = <%- JSON.stringify(package) %>;

  // Get coordinates
  const startCoords = packageData.sender?.address?.coordinates?.coordinates || [-0.1278, 51.5074];
  const endCoords = packageData.receiver?.address?.coordinates?.coordinates || [-0.1278, 51.5074];
  const currentCoords = packageData.trackingData?.currentLocation?.coordinates || startCoords;

  // Initialize Map
  mapboxgl.accessToken = mapboxToken;
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: currentCoords,
    zoom: 10
  });

  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  // Global variables
  let routeCoordinates = [];
  let vehicleMarker = null;
  let checkpointsMarkers = [];
  let animationId = null;

  // Map load event
  map.on('load', async () => {
    try {
      // Fetch route
      const routeGeometry = await fetchRouteGeometry(startCoords, endCoords);
      routeCoordinates = routeGeometry.coordinates;

      // Draw route
      drawRouteLine(routeGeometry);

      // Add markers
      addStaticMarkers(startCoords, endCoords);
      addCheckpointMarkers();

      // Create vehicle marker
      vehicleMarker = createVehicleMarker(currentCoords);

      // Start animation
      startVehicleAnimation();
      fitMapToRoute(routeCoordinates);

    } catch (error) {
      console.error('Map initialization error:', error);
      drawFallbackRoute(startCoords, endCoords);
    }
  });

  // Fetch route geometry
  async function fetchRouteGeometry(start, end) {
    const profile = 'mapbox/driving';
    const coordinates = `${start[0]},${start[1]};${end[0]},${end[1]}`;
    const url = `https://api.mapbox.com/directions/v5/${profile}/${coordinates}?geometries=geojson&overview=full&access_token=${mapboxToken}`;

    const response = await fetch(url);
    const data = await response.json();
    return data.routes[0].geometry;
  }

  // Draw route line
  function drawRouteLine(geometry) {
    map.addSource('route', {
      type: 'geojson',
      data: { type: 'Feature', geometry }
    });

    map.addLayer({
      id: 'route-line',
      type: 'line',
      source: 'route',
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: {
        'line-color': '#667eea',
        'line-width': 4,
        'line-opacity': 0.7
      }
    });
  }

  // Add static markers
  function addStaticMarkers(start, end) {
    // Start marker
    const startEl = document.createElement('div');
    startEl.className = 'checkpoint-marker';
    startEl.innerHTML = '<i class="fas fa-play-circle" style="color: #10b981; font-size: 24px;"></i>';

    new mapboxgl.Marker(startEl)
      .setLngLat(start)
      .setPopup(new mapboxgl.Popup().setHTML(`
          <h6>Pickup Location</h6>
          <p>${packageData.pickupAddress}</p>
        `))
      .addTo(map);

    // End marker
    const endEl = document.createElement('div');
    endEl.className = 'checkpoint-marker';
    endEl.innerHTML = '<i class="fas fa-flag-checkered" style="color: #ef4444; font-size: 24px;"></i>';

    new mapboxgl.Marker(endEl)
      .setLngLat(end)
      .setPopup(new mapboxgl.Popup().setHTML(`
          <h6>Delivery Destination</h6>
          <p>${packageData.deliveryAddress}</p>
        `))
      .addTo(map);
  }

  // Add checkpoint markers
  function addCheckpointMarkers() {
    const waypoints = packageData.trackingData?.waypoints || [];
    waypoints.forEach((wp, idx) => {
      const coords = wp.coordinates || calculatePointAlongRoute(routeCoordinates, (idx + 1) / (waypoints.length + 1));

      const markerEl = document.createElement('div');
      markerEl.className = 'checkpoint-marker';
      markerEl.innerHTML = `<i class="fas fa-map-marker-alt" style="color: ${wp.arrived ? '#10b981' : '#f59e0b'}; font-size: 20px;"></i>`;

      const marker = new mapboxgl.Marker(markerEl)
        .setLngLat(coords)
        .setPopup(new mapboxgl.Popup().setHTML(`
            <h6>${wp.name}</h6>
            <p>${wp.type.toUpperCase()}</p>
          `))
        .addTo(map);

      checkpointsMarkers.push(marker);
    });
  }

  // Create vehicle marker
  function createVehicleMarker(coords) {
    const vehicleEl = document.createElement('div');
    vehicleEl.className = 'vehicle-marker';
    vehicleEl.innerHTML = '<i class="fas fa-truck text-white"></i>';

    return new mapboxgl.Marker(vehicleEl)
      .setLngLat(coords)
      .setPopup(new mapboxgl.Popup().setHTML(`
          <h6>Delivery Vehicle</h6>
          <p>Status: ${packageData.status.replace('_', ' ').toUpperCase()}</p>
          <p>Progress: ${packageData.trackingData?.routeProgress || 0}%</p>
          <p>Speed: ${packageData.trackingData?.speed || 0} km/h</p>
        `))
      .addTo(map);
  }

  // Start vehicle animation
  function startVehicleAnimation() {
    if (!routeCoordinates.length) return;

    const progress = packageData.trackingData?.routeProgress || 0;
    const totalSteps = routeCoordinates.length;
    let currentStep = Math.floor((progress / 100) * (totalSteps - 1));

    vehicleMarker.setLngLat(routeCoordinates[currentStep]);

    if (currentStep < totalSteps - 1) {
      animationId = setInterval(() => {
        if (currentStep >= totalSteps - 1) {
          clearInterval(animationId);
          return;
        }

        currentStep = Math.min(currentStep + 1, totalSteps - 1);
        vehicleMarker.setLngLat(routeCoordinates[currentStep]);

        const currentProgress = Math.min((currentStep / (totalSteps - 1)) * 100, 100);
        document.querySelector('.progress-fill').style.width = `${currentProgress}%`;

      }, 3000);
    }
  }

  // Fit map to route
  function fitMapToRoute(coords) {
    const bounds = new mapboxgl.LngLatBounds();
    coords.forEach(coord => bounds.extend(coord));
    map.fitBounds(bounds, { padding: 50, duration: 2000 });
  }

  // Fallback route
  function drawFallbackRoute(start, end) {
    map.addSource('fallback-route', {
      type: 'geojson',
      data: {
        type: 'Feature',
        geometry: { type: 'LineString', coordinates: [start, end] }
      }
    });

    map.addLayer({
      id: 'fallback-route-line',
      type: 'line',
      source: 'fallback-route',
      layout: { 'line-join': 'round', 'line-cap': 'round' },
      paint: { 'line-color': '#667eea', 'line-width': 4, 'line-opacity': 0.7 }
    });

    addStaticMarkers(start, end);
    fitMapToRoute([start, end]);
  }

  // Calculate point along route
  function calculatePointAlongRoute(routeCoords, percentage) {
    if (!routeCoords || routeCoords.length < 2) return startCoords;

    const totalDistance = turf.length(turf.lineString(routeCoords));
    const targetDistance = totalDistance * Math.min(percentage, 0.99);

    let accumulated = 0;
    for (let i = 0; i < routeCoords.length - 1; i++) {
      const segment = turf.length(turf.lineString([routeCoords[i], routeCoords[i + 1]]));
      if (accumulated + segment >= targetDistance) {
        const segmentPercentage = (targetDistance - accumulated) / segment;
        return [
          routeCoords[i][0] + (routeCoords[i + 1][0] - routeCoords[i][0]) * segmentPercentage,
          routeCoords[i][1] + (routeCoords[i + 1][1] - routeCoords[i][1]) * segmentPercentage
        ];
      }
      accumulated += segment;
    }
    return routeCoords[routeCoords.length - 1];
  }

  // UI Functions
  function toggleCheckpoints() {
    checkpointsMarkers.forEach(marker => {
      const isVisible = marker._map !== null;
      isVisible ? marker.remove() : marker.addTo(map);
    });
  }

  function centerMap() {
    if (routeCoordinates.length > 0) {
      fitMapToRoute(routeCoordinates);
    } else {
      const bounds = new mapboxgl.LngLatBounds();
      bounds.extend(startCoords);
      bounds.extend(endCoords);
      map.fitBounds(bounds, { padding: 50, duration: 1000 });
    }
  }

  function toggleCollapse(element) {
    const content = element.nextElementSibling;
    const icon = element.querySelector('i');

    content.classList.toggle('show');
    icon.classList.toggle('fa-chevron-down');
    icon.classList.toggle('fa-chevron-up');
  }

  // Expose functions
  window.toggleCheckpoints = toggleCheckpoints;
  window.centerMap = centerMap;
  window.toggleCollapse = toggleCollapse;

  // Clean up
  window.addEventListener('beforeunload', () => {
    if (animationId) clearInterval(animationId);
  });
</script>
