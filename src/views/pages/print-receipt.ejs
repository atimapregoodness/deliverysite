<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> - ExpressLog</title>

    <!-- Bootstrap Icons only (smaller footprint) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- html2pdf Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
      :root {
        --primary: #1a365d;
        --secondary: #2d3748;
        --accent: #2b6cb0;
        --light: #f7fafc;
        --border: #e2e8f0;
        --success: #38a169;
        --warning: #d69e2e;
        --danger: #e53e3e;
      }

      @media print {
        .no-print {
          display: none !important;
        }
        body {
          padding: 0;
          background: white;
        }
        .container {
          max-width: 100% !important;
          padding: 0;
        }
      }

      @page {
        margin: 10mm;
        size: auto;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: var(--secondary);
        background: #f8fafc;
        padding: 16px;
      }

      .receipt-card {
        max-width: 780px;
        margin: 0 auto;
        background: white;
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
        position: relative;
      }

      .header {
        background: linear-gradient(135deg, var(--primary), #2c5282);
        color: white;
        padding: 20px 24px;
        position: relative;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 16px;
      }

      .brand {
        flex: 1;
        min-width: 200px;
      }

      .brand h1 {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 4px;
        letter-spacing: -0.3px;
      }

      .brand-subtitle {
        font-size: 12px;
        opacity: 0.9;
        font-weight: 400;
      }

      .tracking-info {
        text-align: right;
      }

      .tracking-id {
        display: inline-block;
        background: rgba(255, 255, 255, 0.15);
        padding: 6px 12px;
        border-radius: 6px;
        font-family: "Courier New", monospace;
        font-weight: 600;
        font-size: 13px;
        letter-spacing: 0.5px;
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .meta-item {
        font-size: 12px;
      }

      .meta-label {
        display: block;
        opacity: 0.8;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
      }

      .meta-value {
        font-weight: 600;
        font-size: 13px;
      }

      .main-content {
        padding: 24px;
      }

      .grid-2col {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
      }

      .section {
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 16px;
      }

      .section-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--primary);
        margin: 0 0 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .section-title i {
        font-size: 14px;
        opacity: 0.8;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 13px;
      }

      .info-label {
        color: #718096;
        font-weight: 500;
        min-width: 140px;
      }

      .info-value {
        font-weight: 500;
        text-align: right;
        flex: 1;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
      }

      .status-delivered {
        background: #c6f6d5;
        color: #22543d;
      }
      .status-in_transit {
        background: #bee3f8;
        color: #2a4365;
      }
      .status-pending {
        background: #fed7d7;
        color: #742a2a;
      }
      .status-delayed {
        background: #feebc8;
        color: #744210;
      }

      .table-compact {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .table-compact th {
        text-align: left;
        padding: 10px 12px;
        background: #edf2f7;
        border-bottom: 2px solid var(--border);
        color: var(--secondary);
        font-weight: 600;
        font-size: 12px;
      }

      .table-compact td {
        padding: 10px 12px;
        border-bottom: 1px solid var(--border);
      }

      .table-compact tr:last-child td {
        border-bottom: none;
      }

      .text-right {
        text-align: right;
      }
      .text-bold {
        font-weight: 600;
      }
      .text-muted {
        color: #718096;
        font-size: 12px;
      }

      .qr-container {
        display: inline-block;
        padding: 8px;
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
      }

      .action-bar {
        background: white;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .btn-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 8px 16px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: white;
        color: var(--secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
      }

      .btn:hover {
        background: #f7fafc;
        border-color: #cbd5e0;
      }

      .btn-primary {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .btn-primary:hover {
        background: #2c5282;
      }

      .footer {
        padding: 16px 24px;
        background: #f8fafc;
        border-top: 1px solid var(--border);
        font-size: 12px;
      }

      .footer-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
      }

      .disclaimer {
        color: #718096;
        line-height: 1.6;
      }

      .print-watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-30deg);
        font-size: 80px;
        opacity: 0.03;
        color: var(--primary);
        pointer-events: none;
        font-weight: 800;
        white-space: nowrap;
      }

      .dimensions {
        font-family: "Courier New", monospace;
        background: #edf2f7;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
      }

      @media (max-width: 640px) {
        body {
          padding: 12px;
        }
        .main-content {
          padding: 16px;
        }
        .grid-2col {
          grid-template-columns: 1fr;
        }
        .header-content {
          flex-direction: column;
        }
        .tracking-info {
          text-align: left;
        }
        .footer-grid {
          grid-template-columns: 1fr;
        }
        .action-bar {
          flex-direction: column;
          align-items: stretch;
        }
        .btn-group {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Action Bar -->
    <div class="action-bar no-print">
      <div class="btn-group">
        <button onclick="window.print()" class="btn btn-primary">
          <i class="bi bi-printer"></i>Print
        </button>
        <button id="btn-pdf" class="btn">
          <i class="bi bi-file-earmark-pdf"></i>PDF
        </button>
        <button id="btn-jpeg" class="btn">
          <i class="bi bi-image"></i>Image
        </button>
      </div>
      <a
        href="/delivery/track/results?trackingId=<%= delivery.trackingId %>"
        class="btn"
        style="text-decoration: none"
      >
        <i class="bi bi-arrow-left"></i>Back to Tracking
      </a>
    </div>

    <!-- Receipt Card -->
    <div class="receipt-card" id="receipt-content">
      <div class="print-watermark">EXPRESSLOG</div>

      <!-- Header -->
      <div class="header">
        <div class="header-content">
          <div class="brand">
            <h1>ExpressLog</h1>
            <div class="brand-subtitle">Premium Logistics & Delivery</div>
          </div>
          <div class="tracking-info">
            <div class="meta-label">Tracking ID</div>
            <div class="tracking-id"><%= delivery.trackingId %></div>
          </div>
        </div>

        <div class="meta-grid">
          <div class="meta-item">
            <span class="meta-label">Receipt #</span>
            <span class="meta-value">#<%= invoice.invoiceNumber %></span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Issued</span>
            <span class="meta-value"><%= currentDate %></span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Status</span>
            <span class="meta-value">
              <% if (delivery.status === 'delivered') { %>
              <span class="status-badge status-delivered">Delivered</span>
              <% } else if (delivery.status === 'in_transit') { %>
              <span class="status-badge status-in_transit">In Transit</span>
              <% } else if (delivery.status === 'delayed') { %>
              <span class="status-badge status-delayed">Delayed</span>
              <% } else { %>
              <span class="status-badge status-pending">Pending</span>
              <% } %>
            </span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Service</span>
            <span class="meta-value">Premium Express</span>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Sender & Receiver -->
        <div class="grid-2col">
          <div class="section">
            <h3 class="section-title"><i class="bi bi-send"></i>Sender</h3>
            <div class="info-row">
              <span class="info-label">Name</span>
              <span class="info-value"><%= delivery.sender.name %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Contact</span>
              <span class="info-value"><%= delivery.sender.phone %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Address</span>
              <span class="info-value text-muted"
                ><%= delivery.formattedSenderAddress %></span
              >
            </div>
          </div>

          <div class="section">
            <h3 class="section-title"><i class="bi bi-geo-alt"></i>Receiver</h3>
            <div class="info-row">
              <span class="info-label">Name</span>
              <span class="info-value"><%= delivery.receiver.name %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Contact</span>
              <span class="info-value"><%= delivery.receiver.phone %></span>
            </div>
            <div class="info-row">
              <span class="info-label">Address</span>
              <span class="info-value text-muted"
                ><%= delivery.formattedReceiverAddress %></span
              >
            </div>
            <% if (delivery.receiver.deliveryInstructions) { %>
            <div class="info-row">
              <span class="info-label">Instructions</span>
              <span class="info-value"
                ><%= delivery.receiver.deliveryInstructions %></span
              >
            </div>
            <% } %>
          </div>
        </div>

        <!-- Package & Timeline -->
        <div class="grid-2col">
          <div class="section">
            <h3 class="section-title">
              <i class="bi bi-box"></i>Package Details
            </h3>
            <table class="table-compact">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Weight</th>
                  <th>Dimensions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <%= delivery.packageDescription || "Standard Package" %>
                  </td>
                  <td><%= delivery.weight %> kg</td>
                  <td>
                    <span class="dimensions"
                      ><%= delivery.dimensions || "N/A" %></span
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="section">
            <h3 class="section-title"><i class="bi bi-clock"></i>Timeline</h3>
            <div class="info-row">
              <span class="info-label">Created</span>
              <span class="info-value"
                ><%= formatDate(delivery.createdAt) %></span
              >
            </div>
            <% if (delivery.estimatedDelivery) { %>
            <div class="info-row">
              <span class="info-label">Estimated</span>
              <span class="info-value"
                ><%= formatDate(delivery.estimatedDelivery) %></span
              >
            </div>
            <% } %> <% if (delivery.actualDelivery) { %>
            <div class="info-row">
              <span class="info-label">Delivered</span>
              <span class="info-value text-bold" style="color: var(--success)">
                <%= formatDate(delivery.actualDelivery) %>
              </span>
            </div>
            <% } %> <% if (delivery.driver) { %>
            <div class="info-row">
              <span class="info-label">Driver</span>
              <span class="info-value"><%= delivery.driver.name %></span>
            </div>
            <% } %>
          </div>
        </div>

        <!-- Invoice -->
        <!-- Invoice -->
        <div class="section">
          <h3 class="section-title">
            <i class="bi bi-receipt"></i>Invoice #<%= invoice.invoiceNumber %>
          </h3>
          <table class="table table-compact">
            <thead>
              <tr>
                <th>Description</th>
                <th>Method</th>
                <th>Status</th>
                <th class="text-right">Amount</th>
              </tr>
            </thead>
            <tbody>
              <!-- Base package item -->
              <tr>
                <td>
                  <%= delivery.package?.description || "Standard Package" %>
                </td>
                <td>—</td>
                <td>—</td>
                <td class="text-right">
                  $<%= (delivery.package?.value || 0).toFixed(2) %>
                </td>
              </tr>

              <!-- Payments -->
              <% let paidTotal = 0; const payments = delivery.package?.payments
              || []; payments.forEach(payment => { if(payment.status === "paid")
              paidTotal += payment.amount; %>
              <tr>
                <td>
                  Payment <% if (payment.reference) { %>
                  <small class="text-muted">(#<%= payment.reference %>)</small>
                  <% } %>
                </td>
                <td><%= payment.method.replace("_", " ") %></td>
                <td>
                  <span
                    class="badge <%= payment.status === 'paid' ? 'bg-success' : payment.status === 'pending' ? 'bg-warning' : 'bg-danger' %>"
                  >
                    <%= payment.status.toUpperCase() %>
                  </span>
                </td>
                <td class="text-right">$<%= payment.amount.toFixed(2) %></td>
              </tr>
              <% }); %>

              <!-- Totals -->
              <tr style="background: #f7fafc">
                <td colspan="3" class="text-bold">TOTAL PACKAGE VALUE</td>
                <td class="text-right text-bold">
                  $<%= (delivery.package?.value || 0).toFixed(2) %>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-bold">TOTAL PAID</td>
                <td class="text-right text-bold text-success">
                  $<%= paidTotal.toFixed(2) %>
                </td>
              </tr>
              <tr>
                <td colspan="3" class="text-bold">BALANCE</td>
                <td class="text-right text-bold text-danger">
                  $<%= ((delivery.package?.value || 0) - paidTotal).toFixed(2)
                  %>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- QR Code -->
        <div
          style="
            text-align: center;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
          "
        >
          <div class="qr-container">
            <div id="qrcode"></div>
          </div>
          <div class="text-muted" style="margin-top: 8px; font-size: 11px">
            Scan to verify & track • Generated: <%= formatDate(new Date()) %>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <div class="footer-grid">
          <div class="disclaimer">
            <strong>Terms:</strong> This receipt serves as proof of transaction.
            All charges are final once shipment is processed. Claims must be
            filed within 48 hours of delivery. ExpressLog is not liable for
            delays due to unforeseen circumstances.
          </div>
          <div>
            <div style="margin-bottom: 8px">
              <div class="meta-label">Customer Support</div>
              <div style="font-size: 11px"><%= company.phone %></div>
              <div style="font-size: 11px"><%= company.email %></div>
            </div>
            <div class="text-muted" style="font-size: 10px">
              Thank you for choosing ExpressLog.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // QR Code Generation
      document.addEventListener("DOMContentLoaded", function () {
        const trackingId = "<%= delivery.trackingId %>";
        const baseUrl = window.location.origin;
        const trackingUrl = `${baseUrl}/delivery/track/results?trackingId=${trackingId}`;

        const qrcodeContainer = document.getElementById("qrcode");
        if (qrcodeContainer) {
          try {
            new QRCode(qrcodeContainer, {
              text: trackingUrl,
              width: 100,
              height: 100,
              colorDark: "#1a365d",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.M,
            });
          } catch (error) {
            qrcodeContainer.innerHTML = `
                        <div style="width:100px;height:100px;display:flex;align-items:center;justify-content:center;background:#f7fafc;color:#718096;font-size:10px;">
                            QR Error
                        </div>`;
          }
        }
      });

      // PDF Export
      document.getElementById("btn-pdf").addEventListener("click", function () {
        const element = document.getElementById("receipt-content");
        const btn = this;
        const originalHTML = btn.innerHTML;

        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>Generating...';
        btn.disabled = true;

        html2pdf()
          .from(element)
          .set({
            margin: [5, 5],
            filename: `ExpressLog_${"<%= delivery.trackingId %>"}.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              logging: false,
              backgroundColor: "#ffffff",
            },
            jsPDF: {
              unit: "mm",
              format: "a4",
              orientation: "portrait",
            },
          })
          .save()
          .finally(() => {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
          });
      });

      // JPEG Export
      document
        .getElementById("btn-jpeg")
        .addEventListener("click", function () {
          const element = document.getElementById("receipt-content");
          const btn = this;
          const originalHTML = btn.innerHTML;

          btn.innerHTML = '<i class="bi bi-hourglass-split"></i>Processing...';
          btn.disabled = true;

          html2canvas(element, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
            logging: false,
          })
            .then((canvas) => {
              const link = document.createElement("a");
              link.download = `ExpressLog_${"<%= delivery.trackingId %>"}.jpg`;
              link.href = canvas.toDataURL("image/jpeg", 0.9);
              link.click();
            })
            .finally(() => {
              btn.innerHTML = originalHTML;
              btn.disabled = false;
            });
        });
    </script>
  </body>
</html>
