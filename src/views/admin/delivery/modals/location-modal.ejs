<!-- Location Update Modal with Dual Progress System -->
<div
  class="modal fade"
  id="locationModal"
  tabindex="-1"
  aria-labelledby="locationModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="locationModalLabel">
          Update Vehicle & Delivery Progress
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form id="locationForm" data-delivery-id="<%= delivery._id %>">
        <div class="modal-body">
          <div class="mb-4">
            <div class="alert alert-info">
              <i class="fas fa-truck me-2"></i>
              <strong>Dual Progress System:</strong> <br />
              • <strong>Vehicle Progress</strong> = Actual position along route
              (controls map location)<br />
              • <strong>Route Progress</strong> = Independent display
              percentage<br />
              <hr class="my-2" />
              Current vehicle position:
              <span class="coordinates fw-bold">
                <!-- Calculate coordinates directly without declaring variables -->
                <%= (delivery.trackingData?.currentLocation?.coordinates?.[0] ||
                0).toFixed(6) %>, <%=
                (delivery.trackingData?.currentLocation?.coordinates?.[1] ||
                0).toFixed(6) %>
              </span>
              <% if (delivery.trackingData?.lastUpdated) { %>
              <br />
              <small class="text-muted">
                Last updated: <%= new
                Date(delivery.trackingData.lastUpdated).toLocaleString() %>
              </small>
              <% } %>
            </div>
          </div>

          <div class="row g-3">
            <!-- VEHICLE PROGRESS - Controls actual map position -->
            <div class="col-12">
              <label class="form-label fw-bold">
                <i class="fas fa-map-marker-alt me-2"></i>Vehicle Progress (Map
                Position):
                <span id="vehicleProgressValue"
                  ><%= delivery.trackingData?.vehicleProgress || 0 %>%</span
                >
              </label>
              <div class="d-flex align-items-center">
                <input
                  type="range"
                  class="form-range flex-grow-1 me-3"
                  name="vehicleProgress"
                  id="vehicleProgressSlider"
                  min="0"
                  max="100"
                  value="<%= delivery.trackingData?.vehicleProgress || 0 %>"
                  oninput="updateVehicleProgressValue(this.value)"
                />
                <input
                  type="number"
                  class="form-control w-25"
                  name="vehicleProgressNumber"
                  id="vehicleProgressNumber"
                  min="0"
                  max="100"
                  value="<%= delivery.trackingData?.vehicleProgress || 0 %>"
                  onchange="syncVehicleProgressInput(this.value)"
                />
              </div>
              <small class="form-text text-muted">
                Controls actual vehicle position on the map. This determines
                coordinates, waypoints, and remaining distance.
              </small>
            </div>

            <!-- ROUTE PROGRESS - Completely independent display -->
            <div class="col-12">
              <label class="form-label fw-bold">
                <i class="fas fa-percentage me-2"></i>Route Progress (Display
                Only):
                <span id="routeProgressValue"
                  ><%= delivery.trackingData?.routeProgress || 0 %>%</span
                >
              </label>
              <div class="d-flex align-items-center">
                <input
                  type="range"
                  class="form-range flex-grow-1 me-3"
                  name="routeProgress"
                  id="routeProgressSlider"
                  min="0"
                  max="100"
                  value="<%= delivery.trackingData?.routeProgress || 0 %>"
                  oninput="updateRouteProgressValue(this.value)"
                />
                <input
                  type="number"
                  class="form-control w-25"
                  name="routeProgressNumber"
                  id="routeProgressNumber"
                  min="0"
                  max="100"
                  value="<%= delivery.trackingData?.routeProgress || 0 %>"
                  onchange="syncRouteProgressInput(this.value)"
                />
              </div>
              <small class="form-text text-muted">
                Independent progress percentage for customer display. Does not
                affect vehicle position.
              </small>
            </div>

            <!-- COORDINATES (Calculated from VEHICLE PROGRESS only) -->
            <div class="col-md-6">
              <label class="form-label"
                >Latitude (Based on Vehicle Progress)</label
              >
              <input
                type="number"
                step="0.000001"
                class="form-control"
                name="latitude"
                id="latitudeInput"
                value="<%= (delivery.trackingData?.currentLocation?.coordinates?.[1] || 0).toFixed(6) %>"
                min="-90"
                max="90"
                readonly
              />
            </div>

            <div class="col-md-6">
              <label class="form-label"
                >Longitude (Based on Vehicle Progress)</label
              >
              <input
                type="number"
                step="0.000001"
                class="form-control"
                name="longitude"
                id="longitudeInput"
                value="<%= (delivery.trackingData?.currentLocation?.coordinates?.[0] || 0).toFixed(6) %>"
                min="-180"
                max="180"
                readonly
              />
            </div>

            <!-- Quick Set Buttons for VEHICLE PROGRESS only -->
            <div class="col-12">
              <label class="form-label fw-bold mb-2"
                >Quick Set Vehicle Position:</label
              >
              <div class="d-flex flex-wrap gap-2 mb-2">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-sm"
                  onclick="setVehicleProgress(0)"
                >
                  <i class="fas fa-play me-2"></i>Start (0%)
                </button>
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm"
                  onclick="setVehicleProgress(25)"
                >
                  Quarter Route (25%)
                </button>
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm"
                  onclick="setVehicleProgress(50)"
                >
                  Halfway (50%)
                </button>
                <button
                  type="button"
                  class="btn btn-outline-info btn-sm"
                  onclick="setVehicleProgress(75)"
                >
                  Near Delivery (75%)
                </button>
                <button
                  type="button"
                  class="btn btn-outline-success btn-sm"
                  onclick="setVehicleProgress(95)"
                >
                  At Destination (95%)
                </button>
                <button
                  type="button"
                  class="btn btn-outline-danger btn-sm"
                  onclick="setVehicleProgress(100)"
                >
                  <i class="fas fa-flag-checkered me-2"></i>Completed (100%)
                </button>
              </div>
            </div>

            <!-- Vehicle Tracking Data -->
            <div class="col-md-6">
              <label class="form-label">Speed (km/h)</label>
              <div class="input-group">
                <input
                  type="number"
                  step="0.1"
                  class="form-control"
                  name="speed"
                  id="speedInput"
                  value="<%= delivery.trackingData?.speed || 0 %>"
                  min="0"
                  max="200"
                />
                <span class="input-group-text">km/h</span>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Bearing (degrees)</label>
              <div class="input-group">
                <input
                  type="number"
                  class="form-control"
                  name="bearing"
                  id="bearingInput"
                  value="<%= delivery.trackingData?.bearing || 0 %>"
                  min="0"
                  max="360"
                />
                <span class="input-group-text">°</span>
              </div>
            </div>

            <!-- Additional Options -->
            <div class="col-12">
              <label class="form-label">Location Source</label>
              <select class="form-select" name="source" id="sourceSelect">
                <option value="vehicle_gps">Vehicle GPS</option>
                <option value="driver_app" selected>Driver App</option>
                <option value="manual">Manual Update</option>
                <option value="warehouse">Warehouse System</option>
              </select>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="updateMap"
                  id="updateMap"
                  value="true"
                  checked
                />
                <label class="form-check-label" for="updateMap">
                  <i class="fas fa-map me-2"></i>Update on live map
                </label>
              </div>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="notifyCustomer"
                  id="notifyCustomer"
                  value="true"
                />
                <label class="form-check-label" for="notifyCustomer">
                  <i class="fas fa-bell me-2"></i>Notify customer of progress
                  update
                </label>
              </div>
            </div>

            <!-- Calculated Data Display (Based on VEHICLE PROGRESS only) -->
            <div class="col-12 mt-3">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">
                    Calculated Data (Based on Vehicle Progress)
                  </h6>
                </div>
                <div class="card-body">
                  <div class="row small">
                    <div class="col-6">
                      <div class="text-muted">Remaining Distance</div>
                      <div id="calculatedDistance" class="fw-bold">
                        <% if (delivery.trackingData?.remainingDistance) { %>
                        <%= (delivery.trackingData.remainingDistance /
                        1000).toFixed(1) %> km <% } else { %> Calculating... <%
                        } %>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="text-muted">Estimated Arrival</div>
                      <div id="calculatedETA" class="fw-bold">
                        <% if (delivery.trackingData?.estimatedArrival) { %> <%=
                        new
                        Date(delivery.trackingData.estimatedArrival).toLocaleString()
                        %> <% } else { %> Not calculated <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Messages -->
            <div class="col-12">
              <div
                id="locationFormError"
                class="alert alert-danger"
                style="display: none"
              ></div>
              <div
                id="locationFormSuccess"
                class="alert alert-success"
                style="display: none"
              ></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="submitLocationBtn">
            <i class="fas fa-sync-alt me-2"></i>Update Progress
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Store delivery data for calculations - FIXED: Use the delivery object directly
  let deliveryData = {
    startLon: <%
      if (delivery.sender?.address?.coordinates?.coordinates?.[0]) {
        %><%= delivery.sender.address.coordinates.coordinates[0] %><%
      } else {
        %>0<%
      }
    %>,
    startLat: <%
      if (delivery.sender?.address?.coordinates?.coordinates?.[1]) {
        %><%= delivery.sender.address.coordinates.coordinates[1] %><%
      } else {
        %>0<%
      }
    %>,
    endLon: <%
      if (delivery.receiver?.address?.coordinates?.coordinates?.[0]) {
        %><%= delivery.receiver.address.coordinates.coordinates[0] %><%
      } else {
        %>0<%
      }
    %>,
    endLat: <%
      if (delivery.receiver?.address?.coordinates?.coordinates?.[1]) {
        %><%= delivery.receiver.address.coordinates.coordinates[1] %><%
      } else {
        %>0<%
      }
    %>,
    totalDistance: <%
      if (delivery.route?.totalDistance) {
        %><%= delivery.route.totalDistance %><%
      } else {
        %>0<%
      }
    %>
  };

  // Vehicle Progress Functions - Controls MAP POSITION
  function updateVehicleProgressValue(value) {
    document.getElementById('vehicleProgressValue').textContent = value + '%';
    document.getElementById('vehicleProgressNumber').value = value;

    // Recalculate coordinates based on vehicle progress (for Mapbox)
    calculateCoordinatesFromProgress(value);
  }

  function syncVehicleProgressInput(value) {
    value = Math.min(100, Math.max(0, parseInt(value) || 0));
    document.getElementById('vehicleProgressSlider').value = value;
    updateVehicleProgressValue(value);
  }

  // Route Progress Functions - INDEPENDENT DISPLAY ONLY
  function updateRouteProgressValue(value) {
    document.getElementById('routeProgressValue').textContent = value + '%';
    document.getElementById('routeProgressNumber').value = value;
    // Route progress DOES NOT affect coordinates
  }

  function syncRouteProgressInput(value) {
    value = Math.min(100, Math.max(0, parseInt(value) || 0));
    document.getElementById('routeProgressSlider').value = value;
    updateRouteProgressValue(value);
  }

  // Quick Set Functions - VEHICLE PROGRESS ONLY
  function setVehicleProgress(value) {
    document.getElementById('vehicleProgressSlider').value = value;
    updateVehicleProgressValue(value);

    // Auto-update speed and bearing based on vehicle position
    if (value >= 95) {
      document.getElementById('speedInput').value = 0; // Stopped at destination
      document.getElementById('bearingInput').value = 0;
    } else if (value >= 75) {
      document.getElementById('speedInput').value = 20; // Slower near destination
      document.getElementById('bearingInput').value = getRandomBearing();
    } else if (value >= 25) {
      document.getElementById('speedInput').value = 60; // Normal speed
      document.getElementById('bearingInput').value = getRandomBearing();
    } else {
      document.getElementById('speedInput').value = 40; // Starting speed
      document.getElementById('bearingInput').value = getRandomBearing();
    }

    // DO NOT update route progress - it's independent
  }

  // Helper function for random bearing
  function getRandomBearing() {
    return Math.floor(Math.random() * 360);
  }

  // Calculate coordinates from vehicle progress (for Mapbox)
  function calculateCoordinatesFromProgress(progress) {
    const percentage = progress / 100;

    // Simple linear interpolation for demo
    // In production, use actual Mapbox route geometry
    const calculatedLon = deliveryData.startLon + (deliveryData.endLon - deliveryData.startLon) * percentage;
    const calculatedLat = deliveryData.startLat + (deliveryData.endLat - deliveryData.startLat) * percentage;

    // Update coordinate inputs
    document.getElementById('longitudeInput').value = calculatedLon.toFixed(6);
    document.getElementById('latitudeInput').value = calculatedLat.toFixed(6);

    // Update displayed coordinates
    const coordsElement = document.querySelector('.coordinates');
    if (coordsElement) {
      coordsElement.textContent = `${calculatedLon.toFixed(6)}, ${calculatedLat.toFixed(6)}`;
    }

    // Update calculated distance based on VEHICLE PROGRESS
    if (deliveryData.totalDistance > 0) {
      const remainingPercentage = (100 - progress) / 100;
      const remainingDistance = deliveryData.totalDistance * remainingPercentage;
      const distanceElement = document.getElementById('calculatedDistance');
      if (distanceElement) {
        distanceElement.textContent = `${(remainingDistance / 1000).toFixed(1)} km`;
      }
    }

    // Update ETA based on VEHICLE PROGRESS and speed
    const speed = parseFloat(document.getElementById('speedInput').value) || 0;
    if (speed > 0 && deliveryData.totalDistance > 0) {
      const remainingDistance = deliveryData.totalDistance * (100 - progress) / 100;
      const remainingHours = remainingDistance / 1000 / speed;
      const eta = new Date(Date.now() + remainingHours * 60 * 60 * 1000);
      const etaElement = document.getElementById('calculatedETA');
      if (etaElement) {
        etaElement.textContent = eta.toLocaleString();
      }
    }
  }

  // Form submission handler
  async function submitLocationForm(event) {
    event.preventDefault();

    const form = event.target;
    const submitBtn = document.getElementById('submitLocationBtn');
    const errorDiv = document.getElementById('locationFormError');
    const successDiv = document.getElementById('locationFormSuccess');
    const deliveryId = form.getAttribute('data-delivery-id');

    // Hide previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';

    // Disable submit button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

    try {
      // Collect form data
      const formData = {
        vehicleProgress: document.getElementById('vehicleProgressSlider').value,
        routeProgress: document.getElementById('routeProgressSlider').value,
        latitude: document.getElementById('latitudeInput').value,
        longitude: document.getElementById('longitudeInput').value,
        speed: document.getElementById('speedInput').value,
        bearing: document.getElementById('bearingInput').value,
        source: document.getElementById('sourceSelect').value,
        updateMap: document.getElementById('updateMap').checked ? 'true' : 'false',
        notifyCustomer: document.getElementById('notifyCustomer').checked ? 'true' : 'false',
      };

      console.log('Sending data:', formData);

      // Use your actual route
      const endpoint = `/admin/deliveries/${deliveryId}/update-location`;

      // Make the API call
      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(formData),
      });

      // Read the response as text FIRST
      const responseText = await response.text();

      // Now try to parse it as JSON
      let result;
      try {
        result = JSON.parse(responseText);
      } catch (parseError) {
        // If it's not JSON, check if it's HTML
        if (responseText.trim().startsWith('<!DOCTYPE') ||
            responseText.trim().startsWith('<html') ||
            responseText.includes('<!DOCTYPE html>')) {
          throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}. Check if the route exists.`);
        } else {
          throw new Error(`Server returned invalid JSON: ${responseText.substring(0, 200)}`);
        }
      }

      console.log('Server response:', result);

      // Handle the response
      if (result.success) {
        successDiv.textContent = result.message || 'Progress updated successfully!';
        successDiv.style.display = 'block';

        // Close modal after 2 seconds
        setTimeout(() => {
          const modalElement = document.getElementById('locationModal');
          if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            }
          }

          // Refresh the page to show updated data
          setTimeout(() => {
            window.location.reload();
          }, 100);
        }, 2000);
      } else {
        errorDiv.textContent = result.error || 'Failed to update progress';
        if (result.details) {
          errorDiv.textContent += ': ' + (Array.isArray(result.details) ? result.details.join(', ') : result.details);
        }
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Update Progress';
      }

    } catch (error) {
      console.error('Submission error:', error);
      errorDiv.textContent = 'Error: ' + error.message;
      errorDiv.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Update Progress';
    }
  }

  // Initialize modal when shown
  document.addEventListener('DOMContentLoaded', function() {
    const modalElement = document.getElementById('locationModal');

    if (modalElement) {
      // Reset messages when modal is shown
      modalElement.addEventListener('show.bs.modal', function() {
        document.getElementById('locationFormError').style.display = 'none';
        document.getElementById('locationFormSuccess').style.display = 'none';

        const submitBtn = document.getElementById('submitLocationBtn');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Update Progress';
        }
      });
    }

    // Attach form submit event
    const locationForm = document.getElementById('locationForm');
    if (locationForm) {
      locationForm.addEventListener('submit', submitLocationForm);
    }

    // Initialize vehicle progress display
    const initialProgress = document.getElementById('vehicleProgressSlider').value;
    updateVehicleProgressValue(initialProgress);
  });
</script>
