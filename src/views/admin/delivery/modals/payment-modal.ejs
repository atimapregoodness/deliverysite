<!-- modals/payment-modal.ejs -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Payment Management</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body">
        <!-- Payment Summary Cards -->
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card bg-primary text-white">
              <div class="card-body p-3">
                <small class="d-block">Total Amount</small>
                <h4 class="mb-0">
                  $<%= (delivery.package.value || 0).toFixed(2) %>
                </h4>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-success text-white">
              <div class="card-body p-3">
                <small class="d-block">Total Paid</small>
                <h4 class="mb-0">
                  $<%= delivery.package.payments ?
                  delivery.package.payments.filter(p => p.status === 'paid')
                  .reduce((sum, p) => sum + (p.amount || 0), 0).toFixed(2) :
                  '0.00' %>
                </h4>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-warning text-dark">
              <div class="card-body p-3">
                <small class="d-block">Balance</small>
                <h4 class="mb-0">
                  $<%= ((delivery.package.value || 0) -
                  (delivery.package.payments ?
                  delivery.package.payments.filter(p => p.status === 'paid')
                  .reduce((sum, p) => sum + (p.amount || 0), 0) : 0)).toFixed(2)
                  %>
                </h4>
              </div>
            </div>
          </div>
        </div>

        <!-- Payments Table -->
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Method</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="paymentsTableBody">
              <% if (delivery.package.payments &&
              delivery.package.payments.length > 0) { %> <%
              delivery.package.payments.forEach((payment, index) => { %>
              <tr>
                <td><%= index + 1 %></td>
                <td>
                  <div><%= payment.description || 'No description' %></div>
                  <% if (payment.reference) { %>
                  <small class="text-muted"><%= payment.reference %></small>
                  <% } %>
                </td>
                <td>$<%= (payment.amount || 0).toFixed(2) %></td>
                <td>
                  <span
                    class="badge bg-<%= payment.status === 'paid' ? 'success' : payment.status === 'pending' ? 'warning' : payment.status === 'failed' ? 'danger' : 'secondary' %>"
                  >
                    <%= payment.status %>
                  </span>
                </td>
                <td>
                  <span class="badge bg-info">
                    <%= payment.method || 'N/A' %>
                  </span>
                </td>
                <td>
                  <%= payment.paidAt ? new
                  Date(payment.paidAt).toLocaleDateString() : '-' %>
                </td>
                <td>
                  <button
                    class="btn btn-outline-danger btn-sm delete-payment-btn"
                    data-index="<%= index %>"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
              <% }); %> <% } else { %>
              <tr>
                <td colspan="7" class="text-center py-4 text-muted">
                  <i class="fas fa-credit-card fa-2x mb-2"></i>
                  <div>No payments recorded</div>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button type="button" class="btn btn-primary" id="addPaymentBtn">
          <i class="fas fa-plus me-2"></i>Add Payment
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="paymentFormModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Payment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <form id="paymentForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="amount" class="form-label">Amount ($)</label>
              <input
                type="number"
                class="form-control"
                id="amount"
                name="amount"
                step="0.01"
                min="0.01"
                required
              />
            </div>

            <div class="col-md-6 mb-3">
              <label for="status" class="form-label">Status</label>
              <select class="form-select" id="status" name="status" required>
                <option value="pending">Pending</option>
                <option value="paid" selected>Paid</option>
                <option value="failed">Failed</option>
                <option value="reversed">Reversed</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="method" class="form-label">Payment Method</label>
              <select class="form-select" id="method" name="method" required>
                <option value="cash">Cash</option>
                <option value="card" selected>Credit/Debit Card</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="crypto">Cryptocurrency</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label for="paidAt" class="form-label">Payment Date</label>
              <input
                type="datetime-local"
                class="form-control"
                id="paidAt"
                name="paidAt"
              />
            </div>
          </div>

          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <input
              type="text"
              class="form-control"
              id="description"
              name="description"
              placeholder="e.g., Deposit, Final Payment"
              required
            />
          </div>

          <div class="mb-3">
            <label for="reference" class="form-label"
              >Reference (Optional)</label
            >
            <input
              type="text"
              class="form-control"
              id="reference"
              name="reference"
              placeholder="Transaction ID, Receipt #"
            />
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" id="paymentSubmitBtn">
            <i class="fas fa-plus me-2"></i>Add Payment
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  class="modal fade"
  id="deletePaymentModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Payment</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <form id="deletePaymentForm">
        <input type="hidden" id="deletePaymentIndex" name="paymentIndex" />

        <div class="modal-body">
          <div class="alert alert-danger mb-3">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Are you sure you want to delete this payment?
          </div>

          <div id="paymentDetails" class="border rounded p-3 bg-light">
            <!-- Payment details will be inserted here -->
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-danger" id="deleteSubmitBtn">
            <i class="fas fa-trash me-2"></i>Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Store payment data
  let payments = [];
  try {
    payments = JSON.parse(
      `<%- JSON.stringify(delivery.package.payments || []) %>`
    );
  } catch (e) {
    console.error("Error parsing payments:", e);
  }

  // DOM Ready
  document.addEventListener("DOMContentLoaded", function () {
    const deliveryId = "<%= delivery._id %>";

    // Initialize date for new payment
    const now = new Date();
    const localDateTime = new Date(
      now.getTime() - now.getTimezoneOffset() * 60000
    )
      .toISOString()
      .slice(0, 16);

    // Set current date/time
    document.getElementById("paidAt").value = localDateTime;

    // Event Delegation for Delete buttons
    document.addEventListener("click", function (e) {
      // Delete Payment Button
      if (e.target.closest(".delete-payment-btn")) {
        e.preventDefault();
        const btn = e.target.closest(".delete-payment-btn");
        const index = parseInt(btn.getAttribute("data-index"));

        if (payments[index]) {
          loadPaymentForDelete(index);
        }
      }
    });

    // Add Payment Button
    document
      .getElementById("addPaymentBtn")
      .addEventListener("click", function (e) {
        e.preventDefault();
        resetPaymentForm();

        const modal = new bootstrap.Modal(
          document.getElementById("paymentFormModal")
        );
        modal.show();
      });

    // Handle Add Payment Form Submission
    const paymentForm = document.getElementById("paymentForm");
    if (paymentForm) {
      paymentForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {
          amount: parseFloat(formData.get("amount")),
          status: formData.get("status"),
          method: formData.get("method"),
          description: formData.get("description"),
          reference: formData.get("reference"),
          paidAt: formData.get("paidAt") || new Date().toISOString(),
        };

        const submitBtn = document.getElementById("paymentSubmitBtn");
        const originalText = submitBtn.innerHTML;

        // Show loading
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
        submitBtn.disabled = true;

        try {
          const response = await fetch(
            `/admin/deliveries/${deliveryId}/payments`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(data),
            }
          );

          const result = await response.json();

          if (result.success) {
            showToast(
              "success",
              result.message || "Payment added successfully"
            );

            // Close modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("paymentFormModal")
            );
            modal.hide();

            // Reload page to show updated data
            setTimeout(() => {
              location.reload();
            }, 1000);
          } else {
            showToast("danger", result.error || "Failed to add payment");
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("danger", "An error occurred while adding payment");
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });
    }

    // Handle Delete Form Submission
    const deleteForm = document.getElementById("deletePaymentForm");
    if (deleteForm) {
      deleteForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const index = document.getElementById("deletePaymentIndex").value;
        const submitBtn = document.getElementById("deleteSubmitBtn");
        const originalText = submitBtn.innerHTML;

        // Show loading
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
        submitBtn.disabled = true;

        try {
          const response = await fetch(
            `/admin/deliveries/${deliveryId}/payments/${index}`,
            {
              method: "DELETE",
              headers: {
                Accept: "application/json",
              },
            }
          );

          const result = await response.json();

          if (result.success) {
            showToast(
              "success",
              result.message || "Payment deleted successfully"
            );

            // Close modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("deletePaymentModal")
            );
            modal.hide();

            // Reload page
            setTimeout(() => {
              location.reload();
            }, 1000);
          } else {
            showToast("danger", result.error || "Failed to delete payment");
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error("Error:", error);
          showToast("danger", "An error occurred while deleting payment");
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      });
    }

    // Reset modals when hidden
    document
      .getElementById("paymentFormModal")
      .addEventListener("hidden.bs.modal", function () {
        resetPaymentForm();
      });

    document
      .getElementById("deletePaymentModal")
      .addEventListener("hidden.bs.modal", function () {
        document.getElementById("paymentDetails").innerHTML = "";
        document.getElementById("deletePaymentIndex").value = "";
      });
  });

  // Helper Functions
  function loadPaymentForDelete(index) {
    const payment = payments[index];
    if (!payment) return;

    document.getElementById("deletePaymentIndex").value = index;

    // Show payment details in confirmation modal
    const details = document.getElementById("paymentDetails");
    details.innerHTML = `
      <div class="mb-2">
        <strong>${payment.description || "No description"}</strong>
      </div>
      <div class="row">
        <div class="col-6">
          <small>Amount:</small>
          <div><strong>$${(payment.amount || 0).toFixed(2)}</strong></div>
        </div>
        <div class="col-6">
          <small>Status:</small>
          <div>
            <span class="badge bg-${
              payment.status === "paid"
                ? "success"
                : payment.status === "pending"
                ? "warning"
                : "secondary"
            }">
              ${payment.status}
            </span>
          </div>
        </div>
      </div>
      <div class="mt-2">
        <small>Method:</small>
        <div>${payment.method || "N/A"}</div>
      </div>
      ${
        payment.reference
          ? `<div class="mt-1"><small>Reference:</small><div>${payment.reference}</div></div>`
          : ""
      }
    `;

    // Show modal
    const modal = new bootstrap.Modal(
      document.getElementById("deletePaymentModal")
    );
    modal.show();
  }

  function resetPaymentForm() {
    const form = document.getElementById("paymentForm");
    if (form) form.reset();

    // Set default values
    document.getElementById("status").value = "paid";
    document.getElementById("method").value = "card";

    // Set current date
    const now = new Date();
    const localDateTime = new Date(
      now.getTime() - now.getTimezoneOffset() * 60000
    )
      .toISOString()
      .slice(0, 16);
    document.getElementById("paidAt").value = localDateTime;
  }

  function showToast(type, message) {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector(".toast-container");
    if (!toastContainer) {
      toastContainer = document.createElement("div");
      toastContainer.className =
        "toast-container position-fixed top-0 end-0 p-3";
      document.body.appendChild(toastContainer);
    }

    // Create toast
    const toastId = "toast-" + Date.now();
    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
    toastEl.id = toastId;

    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas fa-${
            type === "success" ? "check-circle" : "exclamation-circle"
          } me-2"></i>
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    // Remove after hidden
    toastEl.addEventListener("hidden.bs.toast", function () {
      toastEl.remove();
    });
  }
</script>
