<div
  class="modal fade"
  id="incidentModal"
  tabindex="-1"
  aria-labelledby="incidentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="incidentModalLabel">Report Incident</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <form
        id="incidentForm"
        action="/admin/deliveries/<%= delivery._id %>/add-incident"
        method="POST"
      >
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Report any incidents that affect this delivery. This will create a
            record in the delivery history.
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Incident Type *</label>
              <select
                class="form-select"
                name="type"
                required
                id="incidentType"
                onchange="updateIncidentFields()"
              >
                <option value="">Select type</option>
                <option value="accident">Accident</option>
                <option value="breakdown">Vehicle Breakdown</option>
                <option value="traffic">Traffic Delay</option>
                <option value="weather">Weather Conditions</option>
                <option value="customer_issue">Customer Issue</option>
                <option value="package_damage">Package Damage</option>
                <option value="theft">Theft</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Severity *</label>
              <select
                class="form-select"
                name="severity"
                required
                id="severitySelect"
                onchange="updateEmergencyFields()"
              >
                <option value="">Select severity</option>
                <option value="low">Low - Minor issue</option>
                <option value="medium" selected>
                  Medium - Affects delivery time
                </option>
                <option value="high">High - Serious issue</option>
                <option value="critical">Critical - Emergency</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Description *</label>
              <textarea
                class="form-control"
                name="description"
                id="description"
                rows="3"
                required
                placeholder="Describe what happened, including any relevant details"
              ></textarea>
            </div>

            <!-- Dynamic fields container -->
            <div class="row g-3" id="incidentAdditionalFields">
              <!-- Dynamic fields will be inserted here -->
            </div>

            <div class="col-md-6">
              <label class="form-label">Location (Optional)</label>
              <input
                type="text"
                class="form-control"
                name="address"
                placeholder="Address or location where incident occurred"
              />
            </div>
            <div class="col-md-6">
              <label class="form-label">Estimated Delay (minutes)</label>
              <input
                type="number"
                class="form-control"
                name="estimatedDelay"
                value="30"
                min="0"
              />
            </div>

            <div class="col-12" id="emergencyFields" style="display: none">
              <div class="alert alert-danger">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    name="emergencyServices"
                    id="emergencyServices"
                  />
                  <label class="form-check-label" for="emergencyServices">
                    <i class="fas fa-ambulance me-2"></i>Emergency services were
                    called
                  </label>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="driverInvolved"
                  id="driverInvolved"
                  checked
                />
                <label class="form-check-label" for="driverInvolved"
                  >Driver involved in incident</label
                >
              </div>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="packageAffected"
                  id="packageAffected"
                />
                <label class="form-check-label" for="packageAffected"
                  >Package affected/damaged</label
                >
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-warning" id="submitBtn">
            <i class="fas fa-exclamation-triangle me-2"></i>Report Incident
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function updateIncidentFields() {
    const type = document.getElementById("incidentType").value;
    const fieldsContainer = document.getElementById("incidentAdditionalFields");

    let html = "";

    switch (type) {
      case "accident":
        html = `
          <div class="col-md-6">
            <label class="form-label">Other Parties Involved</label>
            <select class="form-select" name="otherParties">
              <option value="none">None</option>
              <option value="other_vehicle">Other Vehicle</option>
              <option value="pedestrian">Pedestrian</option>
              <option value="property">Property</option>
              <option value="multiple">Multiple</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Police Report Number</label>
            <input type="text" class="form-control" name="policeReport" placeholder="If applicable">
          </div>
        `;
        break;
      case "breakdown":
        html = `
          <div class="col-md-6">
            <label class="form-label">Vehicle Issue</label>
            <select class="form-select" name="vehicleIssue">
              <option value="engine">Engine Failure</option>
              <option value="flat_tire">Flat Tire</option>
              <option value="mechanical">Mechanical</option>
              <option value="electrical">Electrical</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tow Truck Required</label>
            <select class="form-select" name="towRequired">
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        `;
        break;
      case "package_damage":
        html = `
          <div class="col-md-6">
            <label class="form-label">Damage Type</label>
            <select class="form-select" name="damageType">
              <option value="wet">Water Damage</option>
              <option value="crushed">Crushed</option>
              <option value="torn">Torn</option>
              <option value="broken">Broken</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Estimated Value Loss (%)</label>
            <input type="number" class="form-control" name="valueLoss" min="0" max="100" placeholder="0-100">
          </div>
        `;
        break;
      case "theft":
        const now = new Date();
        const currentDateTime = now.toISOString().slice(0, 16);
        html = `
          <div class="col-12">
            <div class="alert alert-danger">
              <i class="fas fa-shield-alt me-2"></i>
              <strong>Important:</strong> Report theft incidents to local authorities immediately.
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Police Report Number *</label>
            <input type="text" class="form-control" name="policeReport" required placeholder="Enter police report number">
          </div>
          <div class="col-md-6">
            <label class="form-label">Time of Theft</label>
            <input type="datetime-local" class="form-control" name="theftTime" value="${currentDateTime}">
          </div>
        `;
        break;
    }

    fieldsContainer.innerHTML = html;
  }

  function updateEmergencyFields() {
    const severity = document.getElementById("severitySelect").value;
    const emergencyFields = document.getElementById("emergencyFields");

    if (severity === "critical") {
      emergencyFields.style.display = "block";
    } else {
      emergencyFields.style.display = "none";
      document.getElementById("emergencyServices").checked = false;
    }
  }

  // PURE JAVASCRIPT FORM HANDLER (No jQuery)
  document.addEventListener("DOMContentLoaded", function () {
    updateIncidentFields();
    updateEmergencyFields();

    // Get form elements
    const form = document.getElementById("incidentForm");
    const submitBtn = document.querySelector(
      '#incidentForm button[type="submit"]'
    );
    const incidentModal = document.getElementById("incidentModal");

    if (form) {
      // Handle form submission with AJAX
      submitBtn.addEventListener("click", async function (e) {
        e.preventDefault();
        e.stopPropagation();

        console.log("Form submit button clicked");

        // Validate
        const type = document.getElementById("incidentType").value;
        const severity = document.getElementById("severitySelect").value;
        const description = document.getElementById("description").value;

        if (!type || !severity || !description) {
          alert(
            "Please fill in all required fields: Type, Severity, and Description"
          );
          return;
        }

        // Special validation for theft incidents
        if (type === "theft") {
          const policeReport = document.querySelector(
            'input[name="policeReport"]'
          );
          if (policeReport && !policeReport.value.trim()) {
            alert("Police report number is required for theft incidents");
            policeReport.focus();
            return;
          }
        }

        // Show loading
        submitBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin me-2"></i>Reporting...';
        submitBtn.disabled = true;

        // Collect form data
        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => {
          data[key] = value;
        });

        console.log("Data to send:", data);
        console.log("Sending to:", form.action);

        try {
          // Send AJAX request
          const response = await fetch(form.action, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(data),
          });

          console.log("Response status:", response.status);

          // First check if response is OK
          if (!response.ok) {
            const errorText = await response.text();
            console.error("Server error response:", errorText);
            throw new Error(
              `Server returned ${response.status}: ${response.statusText}`
            );
          }

          // Try to parse as JSON
          const result = await response.json();
          console.log("Response data:", result);

          if (result.success) {
            // Show success message
            alert("Incident reported successfully!");

            // Close modal using Bootstrap 5 JavaScript
            if (incidentModal) {
              const modal = bootstrap.Modal.getInstance(incidentModal);
              if (modal) {
                modal.hide();
              } else {
                // If no instance exists, create one and hide it
                const bsModal = new bootstrap.Modal(incidentModal);
                bsModal.hide();
              }
            }

            // Reload page after a short delay
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            // Show specific error from server
            alert("Error: " + (result.error || "Unknown error occurred"));
            submitBtn.innerHTML =
              '<i class="fas fa-exclamation-triangle me-2"></i>Report Incident';
            submitBtn.disabled = false;
          }
        } catch (error) {
          console.error("Fetch error:", error);
          console.error("Error message:", error.message);

          alert(
            "An error occurred. Please try again. Details: " + error.message
          );
          submitBtn.innerHTML =
            '<i class="fas fa-exclamation-triangle me-2"></i>Report Incident';
          submitBtn.disabled = false;
        }
      });
    }

    // Reset form when modal closes using Bootstrap 5 events
    if (incidentModal) {
      incidentModal.addEventListener("hidden.bs.modal", function () {
        if (form) {
          form.reset();
          updateIncidentFields();
          updateEmergencyFields();
        }
        if (submitBtn) {
          submitBtn.innerHTML =
            '<i class="fas fa-exclamation-triangle me-2"></i>Report Incident';
          submitBtn.disabled = false;
        }
      });
    }
  });
</script>
