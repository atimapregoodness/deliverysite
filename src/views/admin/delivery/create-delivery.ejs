<%- layout('layouts/admin') %>

<!-- Include Mapbox CSS and JS -->
<link
  href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
  type="text/css"
/>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

<style>
  /* All your existing CSS remains the same */
  :root {
    --primary-blue: #2563eb;
    --primary-dark: #1e40af;
    --primary-light: #dbeafe;
    --secondary-teal: #0d9488;
    --secondary-dark: #0f766e;
    --accent-green: #10b981;
    --accent-red: #ef4444;
    --accent-yellow: #f59e0b;
    --accent-orange: #f97316;
    --accent-purple: #8b5cf6;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
  }

  /* Mapbox-specific styles */
  .mapboxgl-ctrl-geocoder {
    width: 100% !important;
    max-width: 100% !important;
    font-size: 0.875rem;
    border-radius: 8px;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .mapboxgl-ctrl-geocoder--input {
    height: 42px;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
  }

  .mapboxgl-ctrl-geocoder--icon {
    top: 10px;
  }

  .map-container {
    height: 300px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--gray-200);
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    margin-top: 1rem;
  }

  .coordinates-display {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .coordinate-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .coordinate-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    font-weight: 500;
  }

  .coordinate-value {
    font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    background: var(--gray-50);
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    color: var(--gray-900);
  }

  .geocoder-loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-top: 0.5rem;
  }

  .geocoder-loading.active {
    display: flex;
  }

  .geocoder-error {
    display: none;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--accent-red);
    margin-top: 0.5rem;
  }

  .geocoder-error.active {
    display: flex;
  }

  .address-validation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }

  .address-validation.valid {
    color: var(--accent-green);
  }

  .address-validation.invalid {
    color: var(--accent-red);
  }

  .geocode-hint {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .geocode-btn {
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
  }

  .geocode-btn:hover {
    background: var(--primary-dark);
  }

  .geocode-btn:disabled {
    background: var(--gray-400);
    cursor: not-allowed;
  }

  .professional-font {
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
  }

  .professional-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid var(--gray-200);
    transition: all 0.2s ease-in-out;
  }

  .professional-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .section-header {
    background: linear-gradient(
      135deg,
      var(--primary-blue) 0%,
      var(--secondary-teal) 100%
    );
    color: white;
    padding: 1.25rem 1.5rem;
    border-radius: 12px 12px 0 0;
    position: relative;
    overflow: hidden;
  }

  .section-header::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(30px, -30px);
  }

  .section-header h3 {
    font-weight: 600;
    font-size: 1.125rem;
    margin: 0;
    position: relative;
    z-index: 2;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .status-pending {
    background: var(--gray-100);
    color: var(--gray-700);
  }
  .status-in_transit {
    background: var(--primary-light);
    color: var(--primary-dark);
  }
  .status-delayed {
    background: var(--accent-yellow);
    color: var(--gray-800);
  }
  .status-delivered {
    background: var(--accent-green);
    color: white;
  }
  .status-cancelled {
    background: var(--gray-300);
    color: var(--gray-700);
  }

  .data-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
  }

  .data-row {
    display: grid;
    grid-template-columns: 1fr 2fr;
    padding: 1rem 1.5rem;
    align-items: start;
    border-bottom: 1px solid var(--gray-200);
    transition: background-color 0.15s ease;
  }

  .data-row:hover {
    background-color: var(--gray-50);
  }

  .data-row:last-child {
    border-bottom: none;
  }

  .data-label {
    font-weight: 500;
    color: var(--gray-700);
    font-size: 0.875rem;
  }

  .data-value {
    color: var(--gray-900);
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .professional-input {
    width: 100%;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    transition: all 0.2s ease;
  }

  .professional-input:hover {
    border-color: var(--primary-blue);
  }

  .professional-input:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .professional-textarea {
    width: 100%;
    min-height: 80px;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    transition: all 0.2s ease;
    resize: vertical;
  }

  .professional-checkbox {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--gray-400);
    border-radius: 4px;
    transition: all 0.2s ease;
    position: relative;
  }

  .professional-checkbox:checked {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
  }

  .professional-checkbox:checked::after {
    content: "";
    position: absolute;
    left: 4px;
    top: 0px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .btn-primary {
    background: linear-gradient(
      135deg,
      var(--primary-blue) 0%,
      var(--primary-dark) 100%
    );
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .btn-secondary {
    background: linear-gradient(
      135deg,
      var(--gray-200) 0%,
      var(--gray-300) 100%
    );
    color: var(--gray-900);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .professional-select {
    width: 100%;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    cursor: pointer;
    transition: all 0.2s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }

  .info-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.2s ease;
  }

  .info-card:hover {
    border-color: var(--primary-blue);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .info-card-header {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.75rem;
    font-size: 1rem;
    border-bottom: 1px solid var(--gray-200);
    padding-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    .data-row {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .section-header {
      padding: 1rem 1.25rem;
    }

    .professional-card {
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }

    .coordinates-display {
      grid-template-columns: 1fr;
    }
  }

  /* Toast messages */
  .toast-message {
    position: fixed;
    top: 1rem;
    right: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .toast-success {
    background-color: #10b981;
  }

  .toast-error {
    background-color: #ef4444;
  }

  .toast-warning {
    background-color: #f59e0b;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Error states */
  .error-input {
    border-color: #ef4444 !important;
  }

  .error-text {
    color: #ef4444;
    font-size: 0.75rem;
    margin-top: 0.25rem;
    display: none;
  }

  .error-text.show {
    display: block;
  }
</style>

<div
  class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 professional-font py-8"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header with Back Navigation -->
    <div class="mb-8">
      <a
        href="/admin/deliveries"
        class="inline-flex items-center text-primary-blue hover:text-primary-dark font-medium transition-colors duration-200"
      >
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"
          ></path>
        </svg>
        Back to Deliveries
      </a>
      <h1 class="text-2xl font-bold text-gray-900 mt-4">Create New Delivery</h1>
    </div>

    <!-- Main Form for Creating Delivery -->
    <form
      action="/admin/deliveries/create"
      method="POST"
      class="space-y-6"
      id="deliveryForm"
    >
      <!-- Main Card -->
      <div class="professional-card">
        <!-- Header Section -->
        <div class="section-header">
          <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between"
          >
            <div class="mb-4 sm:mb-0">
              <h3 class="text-white text-xl font-semibold">
                Create New Delivery
              </h3>
              <p class="text-blue-100 mt-1 text-sm">
                Tracking ID will be generated automatically
              </p>
            </div>
            <div class="flex items-center space-x-4">
              <select
                name="status"
                class="professional-select w-full bg-white/90 backdrop-blur-sm"
                id="statusSelect"
              >
                <option value="pending" selected>Pending</option>
                <option value="in_transit">In Transit</option>
                <option value="delayed">Delayed</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
              <span class="status-badge status-pending" id="statusBadge"
                >PENDING</span
              >
            </div>
          </div>
        </div>

        <!-- Package Information -->
        <div class="data-grid">
          <div class="data-row">
            <dt class="data-label">Package Description *</dt>
            <dd class="data-value">
              <textarea
                name="package[description]"
                class="professional-textarea"
                required
                placeholder="Enter package description"
                id="packageDescription"
              ></textarea>
              <div class="error-text" id="packageDescriptionError"></div>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Category *</dt>
            <dd class="data-value">
              <select
                name="package[category]"
                class="professional-select"
                id="packageCategory"
              >
                <option value="">Select Category</option>
                <option value="electronics">Electronics</option>
                <option value="clothing">Clothing</option>
                <option value="furniture">Furniture</option>
                <option value="documents">Documents</option>
                <option value="food">Food</option>
                <option value="medical">Medical</option>
                <option value="other">Other</option>
              </select>
              <div class="error-text" id="packageCategoryError"></div>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Weight (kg) *</dt>
            <dd class="data-value">
              <input
                type="number"
                name="package[weight]"
                class="professional-input"
                step="0.01"
                min="0.01"
                required
                placeholder="0.00"
                id="packageWeight"
              />
              <div class="error-text" id="packageWeightError"></div>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Dimensions (cm) - Optional</dt>
            <dd class="data-value flex space-x-2">
              <div class="w-1/3">
                <input
                  type="number"
                  name="package[dimensions][length]"
                  class="professional-input"
                  min="0"
                  placeholder="Length"
                  id="packageLength"
                />
              </div>
              <div class="w-1/3">
                <input
                  type="number"
                  name="package[dimensions][width]"
                  class="professional-input"
                  min="0"
                  placeholder="Width"
                  id="packageWidth"
                />
              </div>
              <div class="w-1/3">
                <input
                  type="number"
                  name="package[dimensions][height]"
                  class="professional-input"
                  min="0"
                  placeholder="Height"
                  id="packageHeight"
                />
              </div>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Declared Value ($) *</dt>
            <dd class="data-value">
              <input
                type="number"
                name="package[value]"
                class="professional-input"
                step="0.01"
                min="0"
                required
                placeholder="0.00"
                value="0"
                id="packageValue"
              />
              <div class="error-text" id="packageValueError"></div>
            </dd>
          </div>
        </div>
      </div>

      <!-- Service & Timeline Information -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Service Details Card -->
        <div class="professional-card">
          <div class="section-header">
            <h3>Service Details</h3>
          </div>
          <div class="p-6 space-y-4">
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Driver (Optional)</span>
              <select
                name="driver"
                class="professional-select w-1/2"
                id="driverSelect"
              >
                <option value="" selected>Unassigned</option>
                <% if (drivers && drivers.length > 0) { %> <%
                drivers.forEach(driver => { %>
                <option value="<%= driver._id %>">
                  <%= driver.name %> (<%= driver.phone %>)
                </option>
                <% }); %> <% } %>
              </select>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Warehouse (Optional)</span>
              <select
                name="warehouse"
                class="professional-select w-1/2"
                id="warehouseSelect"
              >
                <option value="" selected>Unassigned</option>
                <% if (warehouses && warehouses.length > 0) { %> <%
                warehouses.forEach(warehouse => { %>
                <option value="<%= warehouse._id %>">
                  <%= warehouse.name %> (<%= warehouse.code %>)
                </option>
                <% }); %> <% } %>
              </select>
            </div>
          </div>
        </div>

        <!-- Timeline Information -->
        <div class="professional-card">
          <div class="section-header">
            <h3>Timeline</h3>
          </div>
          <div class="p-6 space-y-4">
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Estimated Delivery *</span>
              <input
                type="datetime-local"
                name="estimatedDelivery"
                class="professional-input w-1/2 date-input"
                required
                id="estimatedDelivery"
              />
              <div class="error-text" id="estimatedDeliveryError"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sender & Recipient Information -->
      <div class="professional-card">
        <div class="section-header">
          <h3>Sender & Recipient Information</h3>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6">
          <!-- Sender Information -->
          <div class="info-card sender-simple-form">
            <div class="info-card-header flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-primary-blue"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Sender Information *
            </div>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600">Name *</label>
                <input
                  type="text"
                  name="sender[name]"
                  class="professional-input"
                  required
                  placeholder="John Doe"
                  id="senderName"
                />
                <div class="error-text" id="senderNameError"></div>
              </div>
              <div>
                <label class="text-sm text-gray-600">Email *</label>
                <input
                  type="email"
                  name="sender[email]"
                  class="professional-input"
                  required
                  placeholder="john@example.com"
                  id="senderEmail"
                />
                <div class="error-text" id="senderEmailError"></div>
              </div>
              <div>
                <label class="text-sm text-gray-600">Phone *</label>
                <input
                  type="tel"
                  name="sender[phone]"
                  class="professional-input"
                  required
                  placeholder="+1234567890"
                  id="senderPhone"
                />
                <div class="error-text" id="senderPhoneError"></div>
              </div>

              <!-- Address Search with Mapbox for Sender -->
              <div>
                <label class="text-sm text-gray-600">Search Address *</label>
                <div id="sender-geocoder" class="mb-2"></div>
                <div class="geocoder-loading" id="sender-loading">
                  <svg
                    class="animate-spin h-4 w-4 text-primary-blue"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  <span>Geocoding address...</span>
                </div>
                <div class="geocoder-error" id="sender-error">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <span>Unable to geocode address. Please try again.</span>
                </div>
              </div>

              <!-- Address Fields (auto-filled by Mapbox) -->
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="text-sm text-gray-600">Street *</label>
                  <input
                    type="text"
                    name="sender[address][street]"
                    id="sender-street"
                    class="professional-input"
                    required
                    readonly
                  />
                  <div class="error-text" id="senderStreetError"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-gray-600">City *</label>
                    <input
                      type="text"
                      name="sender[address][city]"
                      id="sender-city"
                      class="professional-input"
                      required
                      readonly
                    />
                    <div class="error-text" id="senderCityError"></div>
                  </div>
                  <div>
                    <label class="text-sm text-gray-600"
                      >State (Optional)</label
                    >
                    <input
                      type="text"
                      name="sender[address][state]"
                      id="sender-state"
                      class="professional-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-gray-600"
                      >Postal Code (Optional)</label
                    >
                    <input
                      type="text"
                      name="sender[address][postalCode]"
                      id="sender-postalCode"
                      class="professional-input"
                      readonly
                    />
                  </div>
                  <div>
                    <label class="text-sm text-gray-600">Country *</label>
                    <input
                      type="text"
                      name="sender[address][country]"
                      id="sender-country"
                      class="professional-input"
                      required
                      readonly
                    />
                    <div class="error-text" id="senderCountryError"></div>
                  </div>
                </div>
                <!-- Hidden fields for schema -->
                <input
                  type="hidden"
                  name="sender[address][fullAddress]"
                  id="sender-fullAddress"
                />
                <input
                  type="hidden"
                  name="sender[address][geocoded]"
                  id="sender-geocoded"
                  value="false"
                />
              </div>

              <!-- Coordinates (auto-filled by Mapbox) -->
              <div>
                <label class="text-sm text-gray-600 mb-1 block"
                  >Coordinates (auto-filled)</label
                >
                <input
                  type="hidden"
                  name="sender[address][coordinates][type]"
                  value="Point"
                />
                <div class="coordinates-display">
                  <div class="coordinate-field">
                    <span class="coordinate-label">Longitude</span>
                    <div class="coordinate-value" id="sender-longitude">--</div>
                    <input
                      type="hidden"
                      name="sender[address][coordinates][coordinates][0]"
                      id="sender-lng-input"
                      value="0"
                    />
                  </div>
                  <div class="coordinate-field">
                    <span class="coordinate-label">Latitude</span>
                    <div class="coordinate-value" id="sender-latitude">--</div>
                    <input
                      type="hidden"
                      name="sender[address][coordinates][coordinates][1]"
                      id="sender-lat-input"
                      value="0"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recipient Information -->
          <div class="info-card">
            <div class="info-card-header flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-secondary-teal"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Recipient Information *
            </div>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600">Name *</label>
                <input
                  type="text"
                  name="receiver[name]"
                  class="professional-input"
                  required
                  placeholder="Jane Smith"
                  id="receiverName"
                />
                <div class="error-text" id="receiverNameError"></div>
              </div>
              <div>
                <label class="text-sm text-gray-600">Email *</label>
                <input
                  type="email"
                  name="receiver[email]"
                  class="professional-input"
                  required
                  placeholder="jane@example.com"
                  id="receiverEmail"
                />
                <div class="error-text" id="receiverEmailError"></div>
              </div>
              <div>
                <label class="text-sm text-gray-600">Phone *</label>
                <input
                  type="tel"
                  name="receiver[phone]"
                  class="professional-input"
                  required
                  placeholder="+1234567890"
                  id="receiverPhone"
                />
                <div class="error-text" id="receiverPhoneError"></div>
              </div>

              <!-- Address Search with Mapbox -->
              <div>
                <label class="text-sm text-gray-600">Search Address *</label>
                <div id="receiver-geocoder" class="mb-2"></div>
                <div class="geocoder-loading" id="receiver-loading">
                  <svg
                    class="animate-spin h-4 w-4 text-secondary-teal"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  <span>Geocoding address...</span>
                </div>
                <div class="geocoder-error" id="receiver-error">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <span>Unable to geocode address. Please try again.</span>
                </div>
              </div>

              <!-- Address Fields (auto-filled by Mapbox) -->
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="text-sm text-gray-600">Street *</label>
                  <input
                    type="text"
                    name="receiver[address][street]"
                    id="receiver-street"
                    class="professional-input"
                    required
                    readonly
                  />
                  <div class="error-text" id="receiverStreetError"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-gray-600">City *</label>
                    <input
                      type="text"
                      name="receiver[address][city]"
                      id="receiver-city"
                      class="professional-input"
                      required
                      readonly
                    />
                    <div class="error-text" id="receiverCityError"></div>
                  </div>
                  <div>
                    <label class="text-sm text-gray-600"
                      >State (Optional)</label
                    >
                    <input
                      type="text"
                      name="receiver[address][state]"
                      id="receiver-state"
                      class="professional-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-gray-600"
                      >Postal Code (Optional)</label
                    >
                    <input
                      type="text"
                      name="receiver[address][postalCode]"
                      id="receiver-postalCode"
                      class="professional-input"
                      readonly
                    />
                  </div>
                  <div>
                    <label class="text-sm text-gray-600">Country *</label>
                    <input
                      type="text"
                      name="receiver[address][country]"
                      id="receiver-country"
                      class="professional-input"
                      required
                      readonly
                    />
                    <div class="error-text" id="receiverCountryError"></div>
                  </div>
                </div>
                <!-- Hidden fullAddress field -->
                <input
                  type="hidden"
                  name="receiver[address][fullAddress]"
                  id="receiver-fullAddress"
                />
                <input
                  type="hidden"
                  name="receiver[address][geocoded]"
                  id="receiver-geocoded"
                  value="false"
                />
              </div>

              <!-- Coordinates (auto-filled by Mapbox) -->
              <div>
                <label class="text-sm text-gray-600 mb-1 block"
                  >Coordinates (auto-filled)</label
                >
                <input
                  type="hidden"
                  name="receiver[address][coordinates][type]"
                  value="Point"
                />
                <div class="coordinates-display">
                  <div class="coordinate-field">
                    <span class="coordinate-label">Longitude</span>
                    <div class="coordinate-value" id="receiver-longitude">
                      --
                    </div>
                    <input
                      type="hidden"
                      name="receiver[address][coordinates][coordinates][0]"
                      id="receiver-lng-input"
                      value="0"
                    />
                  </div>
                  <div class="coordinate-field">
                    <span class="coordinate-label">Latitude</span>
                    <div class="coordinate-value" id="receiver-latitude">
                      --
                    </div>
                    <input
                      type="hidden"
                      name="receiver[address][coordinates][coordinates][1]"
                      id="receiver-lat-input"
                      value="0"
                    />
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 gap-4">
                <div class="flex items-center">
                  <label class="flex items-center text-sm text-gray-600">
                    <input
                      type="checkbox"
                      name="receiver[signatureRequired]"
                      class="professional-checkbox mr-2"
                      value="true"
                      checked
                      id="signatureRequired"
                    />
                    Signature Required
                  </label>
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-600"
                  >Delivery Instructions (Optional)</label
                >
                <textarea
                  name="receiver[deliveryInstructions]"
                  class="professional-textarea"
                  placeholder="Special instructions for delivery..."
                  id="deliveryInstructions"
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Map Preview -->
        <div class="p-6 border-t border-gray-200">
          <h4 class="text-sm font-medium text-gray-700 mb-4">Route Preview</h4>
          <div class="map-container" id="map"></div>
          <div class="mt-4 text-sm text-gray-600">
            <p>
              Enter sender and recipient addresses to see route preview. Map
              will update automatically when addresses are selected.
            </p>
          </div>
        </div>
      </div>

      <!-- Additional Information Section -->
      <div class="professional-card">
        <div class="section-header">
          <h3>Additional Information</h3>
        </div>
        <div class="p-6 space-y-4">
          <div>
            <label class="text-sm text-gray-600"
              >Internal Notes (Optional)</label
            >
            <textarea
              name="internalNotes"
              class="professional-textarea"
              placeholder="Internal notes for admin use only..."
              id="internalNotes"
            ></textarea>
          </div>
        </div>
      </div>

      <!-- Hidden fields for schema compliance -->
      <input type="hidden" name="geocoding[provider]" value="mapbox" />
      <input type="hidden" name="trackingData[active]" value="false" />
      <input type="hidden" name="trackingData[routeProgress]" value="0" />
      <input type="hidden" name="trackingData[speed]" value="0" />
      <input type="hidden" name="trackingData[bearing]" value="0" />
      <input type="hidden" name="createdBy" value="<%= user._id %>" />

      <!-- Submit Buttons -->
      <div class="flex justify-end space-x-4 mt-8">
        <button
          type="button"
          class="btn-secondary"
          onclick="window.history.back()"
        >
          Cancel
        </button>
        <button type="submit" class="btn-primary" id="submitBtn">
          Create Delivery
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("deliveryForm");
    const submitBtn = document.getElementById("submitBtn");
    let map = null;
    let routeLayer = null;
    let senderCoordinates = null;
    let receiverCoordinates = null;

    // Status badge update
    const statusSelect = document.getElementById("statusSelect");
    const statusBadge = document.getElementById("statusBadge");

    if (statusSelect && statusBadge) {
      statusSelect.addEventListener("change", function () {
        const status = this.value;
        statusBadge.textContent = status.toUpperCase().replace("_", " ");
        statusBadge.className = `status-badge status-${status}`;
      });
    }

    // Initialize date input with tomorrow's date
    function initializeDateInput() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(12, 0, 0, 0); // Set to 12:00 PM

      const dateInput = document.getElementById("estimatedDelivery");
      if (dateInput && !dateInput.value) {
        dateInput.value = tomorrow.toISOString().slice(0, 16);
      }
    }

    // Generate tracking ID
    function generateTrackingId() {
      const prefix = "DEL";
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return `${prefix}${timestamp}${random}`;
    }

    // Initialize Map
    function initMap() {
      const mapboxToken = "<%= process.env.MAPBOX_ACCESS_TOKEN || '' %>";

      if (!mapboxToken) {
        console.warn("Mapbox access token not configured");
        document.getElementById("map").innerHTML = `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
              <p class="text-yellow-700">Mapbox access token not configured.</p>
              <p class="text-yellow-600 text-sm">Map features disabled.</p>
            </div>
          `;
        return;
      }

      try {
        mapboxgl.accessToken = mapboxToken;
        map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/streets-v11",
          center: [-95.7129, 37.0902], // Center of US
          zoom: 3,
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        // Wait for map to load
        map.on("load", () => {
          console.log("Map loaded successfully");
        });
      } catch (error) {
        console.error("Error initializing map:", error);
        document.getElementById("map").innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
              <p class="text-red-700">Failed to load map: ${error.message}</p>
            </div>
          `;
      }
    }

    // Initialize Mapbox Geocoder
    function initGeocoders() {
      const mapboxToken = "<%= process.env.MAPBOX_ACCESS_TOKEN || '' %>";

      if (!mapboxToken) {
        console.warn("Mapbox access token not configured - geocoding disabled");
        // Show manual input fields
        document.getElementById("sender-geocoder").innerHTML = `
            <input type="text" class="professional-input"
                   placeholder="Enter sender address manually"
                   id="sender-manual-address">
            <p class="text-xs text-gray-500 mt-1">Please fill all address fields below manually.</p>
          `;
        document.getElementById("receiver-geocoder").innerHTML = `
            <input type="text" class="professional-input"
                   placeholder="Enter recipient address manually"
                   id="receiver-manual-address">
            <p class="text-xs text-gray-500 mt-1">Please fill all address fields below manually.</p>
          `;
        return;
      }

      try {
        // Sender Geocoder
        const senderGeocoder = new MapboxGeocoder({
          accessToken: mapboxToken,
          types: "address,place",

          placeholder: "Search sender address...",
        });

        // Add geocoder to DOM
        document
          .getElementById("sender-geocoder")
          .appendChild(senderGeocoder.onAdd());

        // Sender geocoder event handlers
        senderGeocoder.on("result", (e) => {
          processGeocodeResult(e.result, "sender");
        });

        senderGeocoder.on("loading", () => {
          document.getElementById("sender-loading").classList.add("active");
          document.getElementById("sender-error").classList.remove("active");
        });

        senderGeocoder.on("results", () => {
          document.getElementById("sender-loading").classList.remove("active");
        });

        senderGeocoder.on("error", (e) => {
          console.error("Sender geocoder error:", e);
          document.getElementById("sender-loading").classList.remove("active");
          document.getElementById("sender-error").classList.add("active");
          showToast("Failed to geocode sender address", "error");
        });

        // Receiver Geocoder
        const receiverGeocoder = new MapboxGeocoder({
          accessToken: mapboxToken,
          types: "address,place",

          placeholder: "Search recipient address...",
        });

        // Add geocoder to DOM
        document
          .getElementById("receiver-geocoder")
          .appendChild(receiverGeocoder.onAdd());

        // Receiver geocoder event handlers
        receiverGeocoder.on("result", (e) => {
          processGeocodeResult(e.result, "receiver");
        });

        receiverGeocoder.on("loading", () => {
          document.getElementById("receiver-loading").classList.add("active");
          document.getElementById("receiver-error").classList.remove("active");
        });

        receiverGeocoder.on("results", () => {
          document
            .getElementById("receiver-loading")
            .classList.remove("active");
        });

        receiverGeocoder.on("error", (e) => {
          console.error("Receiver geocoder error:", e);
          document
            .getElementById("receiver-loading")
            .classList.remove("active");
          document.getElementById("receiver-error").classList.add("active");
          showToast("Failed to geocode recipient address", "error");
        });
      } catch (error) {
        console.error("Error initializing geocoders:", error);
        showToast("Failed to initialize address search", "error");
      }
    }

    // Process geocode result
    function processGeocodeResult(result, type) {
      try {
        const coordinates = result.geometry.coordinates;
        const [lng, lat] = coordinates;

        // Extract address components
        const address = extractAddressComponents(result);

        // Update form fields
        updateAddressFields(type, address, coordinates);

        // Show success message
        showGeocodeSuccess(type);

        // Update map
        if (type === "sender") {
          senderCoordinates = coordinates;
        } else {
          receiverCoordinates = coordinates;
        }
        updateRouteMap();
      } catch (error) {
        console.error(`Error processing ${type} geocode result:`, error);
        showToast(`Failed to process ${type} address`, "error");
      }
    }

    // Extract address components from Mapbox result
    function extractAddressComponents(result) {
      const context = result.context || [];
      const address = {
        street: "",
        city: "",
        state: "",
        postalCode: "",
        country: "",
        fullAddress: result.place_name || "",
      };

      // Get street address
      if (result.properties && result.properties.address) {
        address.street = `${result.properties.address} ${result.text}`;
      } else {
        address.street = result.text || result.place_name;
      }

      // Extract from context
      context.forEach((item) => {
        const idParts = item.id.split(".");
        if (idParts[0] === "place") {
          address.city = item.text;
        } else if (idParts[0] === "region") {
          address.state = item.text;
        } else if (idParts[0] === "postcode") {
          address.postalCode = item.text;
        } else if (idParts[0] === "country") {
          address.country = item.text;
        }
      });

      // Default to United States if no country found
      if (!address.country) {
        address.country = "United States";
      }

      return address;
    }

    // Update address fields in the form
    function updateAddressFields(type, address, coordinates) {
      const prefix = type === "sender" ? "sender" : "receiver";

      // Update visible fields
      document.getElementById(`${prefix}-street`).value = address.street || "";
      document.getElementById(`${prefix}-city`).value = address.city || "";
      document.getElementById(`${prefix}-state`).value = address.state || "";
      document.getElementById(`${prefix}-postalCode`).value =
        address.postalCode || "";
      document.getElementById(`${prefix}-country`).value =
        address.country || "United States";
      document.getElementById(`${prefix}-fullAddress`).value =
        address.fullAddress || "";

      // Update coordinates display
      document.getElementById(`${prefix}-longitude`).textContent =
        coordinates[0].toFixed(6);
      document.getElementById(`${prefix}-latitude`).textContent =
        coordinates[1].toFixed(6);
      document.getElementById(`${prefix}-lng-input`).value = coordinates[0];
      document.getElementById(`${prefix}-lat-input`).value = coordinates[1];

      // Set geocoded flag
      document.getElementById(`${prefix}-geocoded`).value = "true";

      // Clear any errors
      clearFieldError(`${prefix}StreetError`);
      clearFieldError(`${prefix}CityError`);
      clearFieldError(`${prefix}CountryError`);
    }

    // Show geocode success message
    function showGeocodeSuccess(type) {
      const loadingEl = document.getElementById(`${type}-loading`);
      const originalContent = loadingEl.innerHTML;

      loadingEl.innerHTML = `
          <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
          <span class="text-green-600">Address geocoded successfully!</span>
        `;
      loadingEl.classList.add("active");

      // Reset after 2 seconds
      setTimeout(() => {
        loadingEl.classList.remove("active");
        loadingEl.innerHTML = originalContent;
      }, 2000);
    }

    // Update route on map
    function updateRouteMap() {
      if (!map) return;

      // Clear existing markers
      document
        .querySelectorAll(".mapboxgl-marker")
        .forEach((marker) => marker.remove());

      // Remove existing route layer
      if (map.getLayer("route")) {
        map.removeLayer("route");
      }
      if (map.getSource("route")) {
        map.removeSource("route");
      }

      const bounds = new mapboxgl.LngLatBounds();
      let hasMarkers = false;

      // Add sender marker
      if (
        senderCoordinates &&
        senderCoordinates[0] !== 0 &&
        senderCoordinates[1] !== 0
      ) {
        new mapboxgl.Marker({ color: "#2563eb" })
          .setLngLat(senderCoordinates)
          .setPopup(
            new mapboxgl.Popup().setHTML("<h3 class='font-bold'>Sender</h3>")
          )
          .addTo(map);
        bounds.extend(senderCoordinates);
        hasMarkers = true;
      }

      // Add receiver marker
      if (
        receiverCoordinates &&
        receiverCoordinates[0] !== 0 &&
        receiverCoordinates[1] !== 0
      ) {
        new mapboxgl.Marker({ color: "#0d9488" })
          .setLngLat(receiverCoordinates)
          .setPopup(
            new mapboxgl.Popup().setHTML("<h3 class='font-bold'>Recipient</h3>")
          )
          .addTo(map);
        bounds.extend(receiverCoordinates);
        hasMarkers = true;
      }

      // Fit bounds if we have markers
      if (hasMarkers) {
        if (senderCoordinates && receiverCoordinates) {
          map.fitBounds(bounds, { padding: 100 });
        } else if (senderCoordinates) {
          map.flyTo({
            center: senderCoordinates,
            zoom: 12,
          });
        } else if (receiverCoordinates) {
          map.flyTo({
            center: receiverCoordinates,
            zoom: 12,
          });
        }
      }
    }

    // Form validation
    function setupFormValidation() {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        // Clear all previous errors
        clearAllErrors();

        let isValid = true;

        // Validate package fields
        if (
          !validateRequiredField(
            "packageDescription",
            "Package description is required"
          )
        ) {
          isValid = false;
        }

        if (
          !validateRequiredField(
            "packageCategory",
            "Package category is required"
          )
        ) {
          isValid = false;
        }

        if (
          !validateNumberField(
            "packageWeight",
            "Weight must be greater than 0",
            0.01
          )
        ) {
          isValid = false;
        }

        if (
          !validateNumberField("packageValue", "Value must be 0 or greater", 0)
        ) {
          isValid = false;
        }

        // Validate sender fields
        if (!validateRequiredField("senderName", "Sender name is required")) {
          isValid = false;
        }

        if (
          !validateEmailField("senderEmail", "Valid sender email is required")
        ) {
          isValid = false;
        }

        if (!validateRequiredField("senderPhone", "Sender phone is required")) {
          isValid = false;
        }

        if (
          !validateRequiredField(
            "sender-street",
            "Sender street address is required"
          )
        ) {
          isValid = false;
        }

        if (!validateRequiredField("sender-city", "Sender city is required")) {
          isValid = false;
        }

        if (
          !validateRequiredField("sender-country", "Sender country is required")
        ) {
          isValid = false;
        }

        // Validate receiver fields
        if (
          !validateRequiredField("receiverName", "Recipient name is required")
        ) {
          isValid = false;
        }

        if (
          !validateEmailField(
            "receiverEmail",
            "Valid recipient email is required"
          )
        ) {
          isValid = false;
        }

        if (
          !validateRequiredField("receiverPhone", "Recipient phone is required")
        ) {
          isValid = false;
        }

        if (
          !validateRequiredField(
            "receiver-street",
            "Recipient street address is required"
          )
        ) {
          isValid = false;
        }

        if (
          !validateRequiredField("receiver-city", "Recipient city is required")
        ) {
          isValid = false;
        }

        if (
          !validateRequiredField(
            "receiver-country",
            "Recipient country is required"
          )
        ) {
          isValid = false;
        }

        // Validate estimated delivery date
        if (
          !validateDateField(
            "estimatedDelivery",
            "Estimated delivery date is required"
          )
        ) {
          isValid = false;
        }

        // Check if addresses are geocoded
        const senderGeocoded =
          document.getElementById("sender-geocoded").value === "true";
        const receiverGeocoded =
          document.getElementById("receiver-geocoded").value === "true";

        if (!senderGeocoded || !receiverGeocoded) {
          showToast(
            "Please use the address search to geocode both addresses",
            "warning"
          );
          isValid = false;
        }

        if (isValid) {
          // Prepare form data
          prepareFormData();

          // Show loading state
          submitBtn.innerHTML = `
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Creating Delivery...
            `;
          submitBtn.disabled = true;

          // Submit form
          form.submit();
        } else {
          showToast("Please fix all errors before submitting", "error");
        }
      });
    }

    // Validation helper functions
    function validateRequiredField(fieldId, errorMessage) {
      const field = document.getElementById(fieldId);
      if (!field || !field.value.trim()) {
        showFieldError(fieldId, errorMessage);
        return false;
      }
      return true;
    }

    function validateEmailField(fieldId, errorMessage) {
      const field = document.getElementById(fieldId);
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!field || !emailRegex.test(field.value.trim())) {
        showFieldError(fieldId, errorMessage);
        return false;
      }
      return true;
    }

    function validateNumberField(fieldId, errorMessage, minValue = 0) {
      const field = document.getElementById(fieldId);
      const value = parseFloat(field.value);
      if (!field || isNaN(value) || value < minValue) {
        showFieldError(fieldId, errorMessage);
        return false;
      }
      return true;
    }

    function validateDateField(fieldId, errorMessage) {
      const field = document.getElementById(fieldId);
      if (!field || !field.value) {
        showFieldError(fieldId, errorMessage);
        return false;
      }

      const selectedDate = new Date(field.value);
      const now = new Date();

      if (selectedDate <= now) {
        showFieldError(fieldId, "Estimated delivery must be in the future");
        return false;
      }

      return true;
    }

    function showFieldError(fieldId, message) {
      const field = document.getElementById(fieldId);
      const errorElement = document.getElementById(`${fieldId}Error`);

      if (field) {
        field.classList.add("error-input");
      }

      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.add("show");
      }
    }

    function clearFieldError(fieldId) {
      const field = document.getElementById(fieldId);
      const errorElement = document.getElementById(`${fieldId}Error`);

      if (field) {
        field.classList.remove("error-input");
      }

      if (errorElement) {
        errorElement.classList.remove("show");
      }
    }

    function clearAllErrors() {
      document.querySelectorAll(".error-text").forEach((el) => {
        el.classList.remove("show");
      });
      document.querySelectorAll(".error-input").forEach((el) => {
        el.classList.remove("error-input");
      });
    }

    // Prepare form data before submission
    function prepareFormData() {
      // Handle empty driver/warehouse fields
      const driverSelect = document.getElementById("driverSelect");
      const warehouseSelect = document.getElementById("warehouseSelect");

      if (driverSelect.value === "") {
        driverSelect.disabled = true;
      }

      if (warehouseSelect.value === "") {
        warehouseSelect.disabled = true;
      }

      // Handle signature required checkbox
      const signatureCheckbox = document.getElementById("signatureRequired");
      if (!signatureCheckbox.checked) {
        const hiddenInput = document.createElement("input");
        hiddenInput.type = "hidden";
        hiddenInput.name = "receiver[signatureRequired]";
        hiddenInput.value = "false";
        form.appendChild(hiddenInput);
      }

      // Set current date for timestamps
      const now = new Date().toISOString();
      const historyInput = document.createElement("input");
      historyInput.type = "hidden";
      historyInput.name = "history[0][timestamp]";
      historyInput.value = now;
      form.appendChild(historyInput);
    }

    // Show toast message
    function showToast(message, type = "error") {
      // Remove existing toast
      const existingToast = document.querySelector(".toast-message");
      if (existingToast) {
        existingToast.remove();
      }

      // Create toast
      const toast = document.createElement("div");
      toast.className = `toast-message fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg ${
        type === "success"
          ? "toast-success"
          : type === "warning"
          ? "toast-warning"
          : "toast-error"
      }`;
      toast.textContent = message;

      document.body.appendChild(toast);

      // Remove toast after 5 seconds
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 5000);
    }

    // Initialize everything
    function init() {
      initializeDateInput();
      initMap();
      initGeocoders();
      setupFormValidation();

      // Set default country to United States
      document.getElementById("sender-country").value = "United States";
      document.getElementById("receiver-country").value = "United States";

      console.log("Delivery form initialized successfully");
    }

    // Start initialization
    init();
  });
</script>
