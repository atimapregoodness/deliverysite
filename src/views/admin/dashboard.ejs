<%- layout('layouts/admin') %>
<title>Express Delivery - Admin Dashboard</title>

<!-- Bootstrap Icons -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
/>

<style>
  :root {
    --primary-color: #2563eb;
    --primary-dark: #1d4ed8;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
  }

  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    border-left: 4px solid var(--primary-color);
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
  }

  .stat-card.warning {
    border-left-color: var(--warning-color);
  }

  .stat-card.success {
    border-left-color: var(--success-color);
  }

  .stat-card.danger {
    border-left-color: var(--danger-color);
  }

  .table-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    overflow: hidden;
  }

  .btn-primary {
    background: linear-gradient(
      135deg,
      var(--primary-color) 0%,
      var(--primary-dark) 100%
    );
    border: none;
  }

  .status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .bg-status-pending {
    background: #fef3c7;
    color: #92400e;
  }
  .bg-status-in_transit {
    background: #dbeafe;
    color: #1e40af;
  }
  .bg-status-delivered {
    background: #d1fae5;
    color: #065f46;
  }
  .bg-status-delayed {
    background: #fee2e2;
    color: #991b1b;
  }

  .action-btn {
    padding: 4px 8px;
    border: none;
    border-radius: 6px;
    margin: 0 2px;
    transition: all 0.3s;
  }

  .action-btn:hover {
    transform: scale(1.1);
  }
</style>

<div class="container-fluid">
  <!-- Header -->
  <div
    class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
  >
    <h1 class="h2 text-dark">Dashboard Overview</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group me-2">
        <button type="button" class="btn btn-sm btn-outline-secondary">
          Today
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary">
          Week
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary">
          Month
        </button>
      </div>
      <a href="/admin/deliveries/create">
        <button type="button" class="btn btn-sm btn-primary">
          <i class="bi bi-plus-circle"></i> New Delivery
        </button>
      </a>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stat-card">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Total Deliveries</h6>
            <h3 class="fw-bold mb-0" id="total-deliveries">156</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-truck text-primary" style="font-size: 2rem"></i>
          </div>
        </div>
        <small class="text-success"
          ><i class="bi bi-arrow-up"></i> 12% from last week</small
        >
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stat-card success">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Active Deliveries</h6>
            <h3 class="fw-bold mb-0" id="active-deliveries">23</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-clock text-success" style="font-size: 2rem"></i>
          </div>
        </div>
        <small class="text-success"
          ><i class="bi bi-arrow-up"></i> 5% from yesterday</small
        >
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stat-card warning">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Pending Deliveries</h6>
            <h3 class="fw-bold mb-0" id="pending-deliveries">8</h3>
          </div>
          <div class="align-self-center">
            <i
              class="bi bi-hourglass-split text-warning"
              style="font-size: 2rem"
            ></i>
          </div>
        </div>
        <small class="text-danger"
          ><i class="bi bi-arrow-down"></i> 2% from yesterday</small
        >
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="stat-card danger">
        <div class="d-flex justify-content-between">
          <div>
            <h6 class="text-muted mb-2">Delayed Deliveries</h6>
            <h3 class="fw-bold mb-0" id="delayed-deliveries">3</h3>
          </div>
          <div class="align-self-center">
            <i
              class="bi bi-exclamation-triangle text-danger"
              style="font-size: 2rem"
            ></i>
          </div>
        </div>
        <small class="text-danger"
          ><i class="bi bi-arrow-up"></i> 1 new delay</small
        >
      </div>
    </div>
  </div>

  <!-- Recent Deliveries Table -->
  <div class="row">
    <div class="col-12">
      <div class="table-card">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">Recent Deliveries</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Tracking ID</th>
                  <th>Customer</th>
                  <th>Driver</th>
                  <th>Status</th>
                  <th>ETA</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="deliveries-table">
                <!-- Delivery data will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="table-card">
        <div class="card-header bg-white border-bottom">
          <h5 class="card-title mb-0">Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <a href="/admin/deliveries/create">
                <button class="btn btn-outline-primary w-100 h-100 py-3">
                  <i
                    class="bi bi-plus-circle d-block mb-2"
                    style="font-size: 1.5rem"
                  ></i>
                  Create Delivery
                </button>
              </a>
            </div>
            <div class="col-md-3">
              <button
                class="btn btn-outline-success w-100 h-100 py-3"
                onclick="openAssignDriverModal()"
              >
                <i
                  class="bi bi-person-plus d-block mb-2"
                  style="font-size: 1.5rem"
                ></i>
                Assign Driver
              </button>
            </div>
            <div class="col-md-3">
              <button
                class="btn btn-outline-warning w-100 h-100 py-3"
                onclick="openRouteOptimization()"
              >
                <i class="bi bi-map d-block mb-2" style="font-size: 1.5rem"></i>
                Optimize Routes
              </button>
            </div>
            <div class="col-md-3">
              <button
                class="btn btn-outline-info w-100 h-100 py-3"
                onclick="generateReport()"
              >
                <i
                  class="bi bi-graph-up d-block mb-2"
                  style="font-size: 1.5rem"
                ></i>
                Generate Report
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals will be added here -->

<script>
  // Initialize dashboard
  document.addEventListener("DOMContentLoaded", function () {
    loadDashboardData();
    setInterval(loadDashboardData, 30000); // Refresh every 30 seconds
  });

  // Load dashboard data
  async function loadDashboardData() {
    try {
      const response = await fetch("/admin/dashboard");
      const data = await response.json();

      if (data.success) {
        updateDashboardStats(data.data.stats);
        updateDeliveriesTable(data.data.recentActivities);
      }
    } catch (error) {
      console.error("Error loading dashboard data:", error);
    }
  }

  // Update dashboard statistics
  function updateDashboardStats(stats) {
    document.getElementById("total-deliveries").textContent =
      stats.todayDeliveries || 0;
    document.getElementById("active-deliveries").textContent =
      stats.activeDeliveries || 0;
    document.getElementById("pending-deliveries").textContent =
      stats.pendingDeliveries || 0;
    document.getElementById("delayed-deliveries").textContent =
      stats.delayedDeliveries || 0;
  }

  // Update deliveries table
  function updateDeliveriesTable(deliveries) {
    const tableBody = document.getElementById("deliveries-table");
    tableBody.innerHTML = "";

    deliveries.forEach((delivery) => {
      const row = document.createElement("tr");

      const statusClass = `bg-status-${delivery.status}`;
      const statusText = delivery.status
        .replace("_", " ")
        .replace(/\b\w/g, (l) => l.toUpperCase());

      row.innerHTML = `
        <td class="fw-bold">${delivery.trackingId}</td>
        <td>${delivery.customer?.name || "N/A"}</td>
        <td>${delivery.driver?.name || "Unassigned"}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td>${
          delivery.estimatedDelivery
            ? new Date(delivery.estimatedDelivery).toLocaleTimeString()
            : "N/A"
        }</td>
        <td>
          <button class="btn btn-sm btn-outline-primary action-btn" onclick="viewDelivery('${
            delivery._id
          }')" title="Edit">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteDelivery('${
            delivery._id
          }')" title="Delete">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;

      tableBody.appendChild(row);
    });
  }

  // Action functions
  function viewDelivery(deliveryId) {
    window.location.href = `/admin/deliveries/${deliveryId}`;
  }

  function editDelivery(deliveryId) {
    // Open edit modal or redirect to edit page
    alert(`Edit delivery: ${deliveryId}`);
  }

  function deleteDelivery(deliveryId) {
    if (confirm("Are you sure you want to delete this delivery?")) {
      fetch(`/admin/deliveries/${deliveryId}`, {
        method: "DELETE",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            loadDashboardData(); // Refresh data
            alert("Delivery deleted successfully");
          }
        });
    }
  }

  function openCreateDeliveryModal() {
    alert("Open create delivery modal");
  }

  function openAssignDriverModal() {
    alert("Open assign driver modal");
  }

  function openRouteOptimization() {
    alert("Open route optimization");
  }

  function generateReport() {
    alert("Generate report");
  }
</script>
