<div class="modal fade" id="driverModal" tabindex="-1" aria-labelledby="driverModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="driverModalLabel">Assign Driver & Warehouse</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="driverForm" data-delivery-id="<%= delivery._id %>">
        <div class="modal-body">
          <div class="mb-4">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              Assign a driver and warehouse to this delivery. The driver will be notified of the assignment.
            </div>
          </div>
          
          <div class="row g-3">
            <!-- Driver Selection -->
            <div class="col-12">
              <label class="form-label">Select Driver</label>
              <select class="form-select" name="driverId" id="driverSelect" onchange="updateDriverInfo()">
                <option value="">Unassigned - Remove current driver</option>
                <% if (drivers && drivers.length > 0) { %>
                  <% drivers.forEach(function(driver) { %>
                    <% 
                      let selected = false;
                      let driverId = '';
                      let driverPhone = driver.phone || '';
                      let driverEmail = driver.email || '';
                      let driverStatus = driver.status || 'unknown';
                      
                      // Handle driver object
                      if (driver._id) {
                        driverId = driver._id.toString();
                      }
                      
                      // Handle delivery.driver (could be ObjectId string or populated object)
                      if (delivery.driver) {
                        if (typeof delivery.driver === 'object' && delivery.driver._id) {
                          selected = driverId === delivery.driver._id.toString();
                        } else if (typeof delivery.driver === 'string') {
                          selected = driverId === delivery.driver;
                        }
                      }
                    %>
                    <option value="<%= driverId %>" 
                            <%= selected ? 'selected' : '' %> 
                            data-phone="<%= driverPhone %>" 
                            data-email="<%= driverEmail %>"
                            data-status="<%= driverStatus %>">
                      <%= driver.name || 'Unknown Driver' %> 
                      <% if (driverPhone) { %> - <%= driverPhone %><% } %>
                      - <%= driverStatus %>
                    </option>
                  <% }) %>
                <% } else { %>
                  <option value="" disabled>No available drivers</option>
                <% } %>
              </select>
            </div>
            
            <!-- Driver Info Display -->
            <div class="col-12" id="driverInfo" style="display: none;">
              <div class="card border-primary">
                <div class="card-body">
                  <h6 class="card-title">Selected Driver Information</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <small class="text-muted">Phone</small>
                      <div id="driverPhone" class="fw-semibold">Not available</div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Email</small>
                      <div id="driverEmail" class="fw-semibold">Not available</div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Status</small>
                      <div id="driverStatus" class="fw-semibold">Not available</div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Assigned Deliveries</small>
                      <div id="driverDeliveries" class="fw-semibold">
                        <% if (delivery.driver && delivery.driver.currentDeliveries) { %>
                          <%= delivery.driver.currentDeliveries.length %> active
                        <% } else { %>
                          No active deliveries
                        <% } %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Warehouse Selection -->
            <div class="col-12">
              <label class="form-label">Select Warehouse</label>
              <select class="form-select" name="warehouseId" id="warehouseSelect" onchange="updateWarehouseInfo()">
                <option value="">Unassigned - Remove current warehouse</option>
                <% if (warehouses && warehouses.length > 0) { %>
                  <% warehouses.forEach(function(warehouse) { %>
                    <% 
                      let selected = false;
                      let warehouseId = '';
                      let warehouseName = warehouse.name || '';
                      let warehouseCode = warehouse.code || '';
                      let warehouseLocation = '';
                      let warehouseType = warehouse.type || '';
                      
                      // Handle warehouse object
                      if (warehouse._id) {
                        warehouseId = warehouse._id.toString();
                      }
                      
                      // Handle delivery.warehouse (could be ObjectId string or populated object)
                      if (delivery.warehouse) {
                        if (typeof delivery.warehouse === 'object' && delivery.warehouse._id) {
                          selected = warehouseId === delivery.warehouse._id.toString();
                        } else if (typeof delivery.warehouse === 'string') {
                          selected = warehouseId === delivery.warehouse;
                        }
                      }
                      
                      // Format location coordinates for display
                      if (warehouse.location && warehouse.location.coordinates) {
                        warehouseLocation = warehouse.location.coordinates.join(', ');
                      }
                    %>
                    <option value="<%= warehouseId %>" 
                            <%= selected ? 'selected' : '' %>
                            data-name="<%= warehouseName %>"
                            data-code="<%= warehouseCode %>"
                            data-location="<%= warehouseLocation %>"
                            data-type="<%= warehouseType %>">
                      <%= warehouseName %> 
                      <% if (warehouseCode) { %> (<%= warehouseCode %>)<% } %>
                      <% if (warehouseType) { %> - <%= warehouseType.replace('_', ' ') %><% } %>
                    </option>
                  <% }) %>
                <% } else { %>
                  <option value="" disabled>No available warehouses</option>
                <% } %>
              </select>
            </div>
            
            <!-- Warehouse Info Display -->
            <div class="col-12" id="warehouseInfo" style="display: none;">
              <div class="card border-success">
                <div class="card-body">
                  <h6 class="card-title">Selected Warehouse Information</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <small class="text-muted">Name</small>
                      <div id="warehouseName" class="fw-semibold">Not available</div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Code</small>
                      <div id="warehouseCode" class="fw-semibold">Not available</div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Type</small>
                      <div id="warehouseType" class="fw-semibold">Not available</div>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Location</small>
                      <div id="warehouseLocation" class="fw-semibold">Not available</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Assignment Options -->
            <div class="col-12 mt-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="notifyDriver" id="notifyDriver" value="true" checked>
                <label class="form-check-label" for="notifyDriver">
                  <i class="fas fa-bell me-2"></i>Notify driver of assignment
                </label>
              </div>
            </div>
            
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="updateSchedule" id="updateSchedule" value="true" checked>
                <label class="form-check-label" for="updateSchedule">
                  Update driver's schedule
                </label>
              </div>
            </div>
            
            <!-- Notes -->
            <div class="col-12">
              <label class="form-label">Assignment Notes (Optional)</label>
              <textarea class="form-control" name="notes" rows="2" 
                        placeholder="Add any notes about this assignment"></textarea>
            </div>
            
            <!-- Error Message Area -->
            <div class="col-12">
              <div id="driverFormError" class="alert alert-danger" style="display: none;"></div>
              <div id="driverFormSuccess" class="alert alert-success" style="display: none;"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="submitDriverBtn">
            <i class="fas fa-user-check me-2"></i>Assign Driver & Warehouse
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Store current values to detect changes
  let currentDriverId = '';
  let currentWarehouseId = '';
  
  function updateDriverInfo() {
    const select = document.getElementById('driverSelect');
    const selectedOption = select.options[select.selectedIndex];
    const driverInfo = document.getElementById('driverInfo');
    
    if (selectedOption && selectedOption.value) {
      const phone = selectedOption.dataset.phone || 'Not available';
      const email = selectedOption.dataset.email || 'Not available';
      const status = selectedOption.dataset.status || 'Unknown';
      
      document.getElementById('driverPhone').textContent = phone;
      document.getElementById('driverEmail').textContent = email;
      document.getElementById('driverStatus').textContent = status;
      
      driverInfo.style.display = 'block';
    } else {
      driverInfo.style.display = 'none';
    }
  }
  
  function updateWarehouseInfo() {
    const select = document.getElementById('warehouseSelect');
    const selectedOption = select.options[select.selectedIndex];
    const warehouseInfo = document.getElementById('warehouseInfo');
    
    if (selectedOption && selectedOption.value) {
      const name = selectedOption.dataset.name || 'Not available';
      const code = selectedOption.dataset.code || 'Not available';
      const location = selectedOption.dataset.location || 'Not available';
      const type = selectedOption.dataset.type || 'Not specified';
      
      document.getElementById('warehouseName').textContent = name;
      document.getElementById('warehouseCode').textContent = code;
      document.getElementById('warehouseLocation').textContent = location;
      document.getElementById('warehouseType').textContent = type;
      
      warehouseInfo.style.display = 'block';
    } else {
      warehouseInfo.style.display = 'none';
    }
  }
  
  // Handle form submission with AJAX
  document.addEventListener('DOMContentLoaded', function() {
    const driverForm = document.getElementById('driverForm');
    const submitBtn = document.getElementById('submitDriverBtn');
    const errorDiv = document.getElementById('driverFormError');
    const successDiv = document.getElementById('driverFormSuccess');
    
    if (driverForm) {
      // Store current values
      currentDriverId = document.getElementById('driverSelect').value;
      currentWarehouseId = document.getElementById('warehouseSelect').value;
      
      // Initialize on page load
      updateDriverInfo();
      updateWarehouseInfo();
      
      driverForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Reset messages
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';
        
        // Get form data
        const formData = new FormData(driverForm);
        const data = {};
        
        // Track what we're actually sending
        const newDriverId = document.getElementById('driverSelect').value;
        const newWarehouseId = document.getElementById('warehouseSelect').value;
        
        // Build data object - send empty string for unassigned, don't send unchanged values
        if (newDriverId !== currentDriverId) {
          data.driverId = newDriverId || '';
        }
        
        if (newWarehouseId !== currentWarehouseId) {
          data.warehouseId = newWarehouseId || '';
        }
        
        // Add checkboxes if needed
        const notifyDriver = document.getElementById('notifyDriver');
        const updateSchedule = document.getElementById('updateSchedule');
        if (notifyDriver) data.notifyDriver = notifyDriver.checked;
        if (updateSchedule) data.updateSchedule = updateSchedule.checked;
        
        // Add notes if not empty
        const notes = driverForm.querySelector('textarea[name="notes"]');
        if (notes && notes.value.trim()) {
          data.notes = notes.value.trim();
        }
        
        // Check if we have any changes
        if (Object.keys(data).length === 0) {
          errorDiv.textContent = 'No changes made. Please select a different driver or warehouse.';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Get delivery ID from data attribute
        const deliveryId = driverForm.dataset.deliveryId;
        
        // Show loading state
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Assigning...';
        submitBtn.disabled = true;
        
        try {
          console.log('Sending assignment data:', data);
          
          const response = await fetch(`/admin/deliveries/${deliveryId}/assign-driver`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
          });
          
          // Check if response is JSON
          const contentType = response.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response:', text.substring(0, 200));
            throw new Error(`Server error: Received non-JSON response (Status: ${response.status})`);
          }
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.error || `HTTP error! status: ${response.status}`);
          }
          
          if (result.success) {
            // Show success message
            successDiv.textContent = result.message || 'Assignment successful!';
            successDiv.style.display = 'block';
            
            // Update current values
            currentDriverId = newDriverId;
            currentWarehouseId = newWarehouseId;
            
            // Close modal after 2 seconds
            setTimeout(() => {
              const modalElement = document.getElementById('driverModal');
              if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) modal.hide();
              }
              
              // Show toast notification
              showToast('success', 'Assignment Successful', result.message);
              
              // Reload the page after a short delay to show updated data
              setTimeout(() => {
                window.location.reload();
              }, 1500);
            }, 2000);
          } else {
            throw new Error(result.error || 'Failed to assign driver/warehouse');
          }
          
        } catch (error) {
          console.error('Error:', error);
          errorDiv.textContent = error.message || 'An error occurred while assigning driver/warehouse';
          errorDiv.style.display = 'block';
          
          // Reset button
          submitBtn.innerHTML = originalBtnText;
          submitBtn.disabled = false;
        }
      });
    }
  });
  
  function showToast(type, title, message) {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas ${icon} me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, {
      autohide: type === 'success',
      delay: type === 'success' ? 3000 : 5000
    });
    
    bsToast.show();
    
    // Remove toast after it's hidden
    toast.addEventListener('hidden.bs.toast', function () {
      toast.remove();
    });
  }
  
  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
  }
</script>