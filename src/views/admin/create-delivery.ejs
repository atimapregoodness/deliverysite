<%- layout('layouts/admin') %>

<!-- Include Mapbox CSS and JS -->
<link
  href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
  rel="stylesheet"
/>
<link
  rel="stylesheet"
  href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
  type="text/css"
/>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

<style>
  /* All your existing CSS remains the same */
  :root {
    --primary-blue: #2563eb;
    --primary-dark: #1e40af;
    --primary-light: #dbeafe;
    --secondary-teal: #0d9488;
    --secondary-dark: #0f766e;
    --accent-green: #10b981;
    --accent-red: #ef4444;
    --accent-yellow: #f59e0b;
    --accent-orange: #f97316;
    --accent-purple: #8b5cf6;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
  }

  /* Mapbox-specific styles */
  .mapboxgl-ctrl-geocoder {
    width: 100% !important;
    max-width: 100% !important;
    font-size: 0.875rem;
    border-radius: 8px;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .mapboxgl-ctrl-geocoder--input {
    height: 42px;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
  }

  .mapboxgl-ctrl-geocoder--icon {
    top: 10px;
  }

  .map-container {
    height: 300px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--gray-200);
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    margin-top: 1rem;
  }

  .coordinates-display {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .coordinate-field {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .coordinate-label {
    font-size: 0.75rem;
    color: var(--gray-600);
    font-weight: 500;
  }

  .coordinate-value {
    font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
    background: var(--gray-50);
    border: 1px solid var(--gray-300);
    border-radius: 6px;
    color: var(--gray-900);
  }

  .geocoder-loading {
    display: none;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-600);
    margin-top: 0.5rem;
  }

  .geocoder-loading.active {
    display: flex;
  }

  .geocoder-error {
    display: none;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--accent-red);
    margin-top: 0.5rem;
  }

  .geocoder-error.active {
    display: flex;
  }

  .address-validation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    margin-top: 0.25rem;
  }

  .address-validation.valid {
    color: var(--accent-green);
  }

  .address-validation.invalid {
    color: var(--accent-red);
  }

  .geocode-hint {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-top: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .geocode-btn {
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
  }

  .geocode-btn:hover {
    background: var(--primary-dark);
  }

  .geocode-btn:disabled {
    background: var(--gray-400);
    cursor: not-allowed;
  }

  .professional-font {
    font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      sans-serif;
  }

  .professional-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border: 1px solid var(--gray-200);
    transition: all 0.2s ease-in-out;
  }

  .professional-card:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .section-header {
    background: linear-gradient(
      135deg,
      var(--primary-blue) 0%,
      var(--secondary-teal) 100%
    );
    color: white;
    padding: 1.25rem 1.5rem;
    border-radius: 12px 12px 0 0;
    position: relative;
    overflow: hidden;
  }

  .section-header::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    transform: translate(30px, -30px);
  }

  .section-header h3 {
    font-weight: 600;
    font-size: 1.125rem;
    margin: 0;
    position: relative;
    z-index: 2;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .status-pending {
    background: var(--gray-100);
    color: var(--gray-700);
  }
  .status-confirmed {
    background: var(--primary-light);
    color: var(--primary-dark);
  }

  .data-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0;
  }

  .data-row {
    display: grid;
    grid-template-columns: 1fr 2fr;
    padding: 1rem 1.5rem;
    align-items: start;
    border-bottom: 1px solid var(--gray-200);
    transition: background-color 0.15s ease;
  }

  .data-row:hover {
    background-color: var(--gray-50);
  }

  .data-row:last-child {
    border-bottom: none;
  }

  .data-label {
    font-weight: 500;
    color: var(--gray-700);
    font-size: 0.875rem;
  }

  .data-value {
    color: var(--gray-900);
    font-size: 0.875rem;
    line-height: 1.5;
  }

  .professional-input {
    width: 100%;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    transition: all 0.2s ease;
  }

  .professional-input:hover {
    border-color: var(--primary-blue);
  }

  .professional-input:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .professional-textarea {
    width: 100%;
    min-height: 80px;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    transition: all 0.2s ease;
    resize: vertical;
  }

  .professional-checkbox {
    appearance: none;
    width: 16px;
    height: 16px;
    border: 2px solid var(--gray-400);
    border-radius: 4px;
    transition: all 0.2s ease;
    position: relative;
  }

  .professional-checkbox:checked {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
  }

  .professional-checkbox:checked::after {
    content: "";
    position: absolute;
    left: 4px;
    top: 0px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .btn-primary {
    background: linear-gradient(
      135deg,
      var(--primary-blue) 0%,
      var(--primary-dark) 100%
    );
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .btn-secondary {
    background: linear-gradient(
      135deg,
      var(--gray-200) 0%,
      var(--gray-300) 100%
    );
    color: var(--gray-900);
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 500;
    font-size: 0.875rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  }

  .btn-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .professional-select {
    width: 100%;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 2.5rem 0.5rem 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-900);
    cursor: pointer;
    transition: all 0.2s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
  }

  .info-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.2s ease;
  }

  .info-card:hover {
    border-color: var(--primary-blue);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
      0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .info-card-header {
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: 0.75rem;
    font-size: 1rem;
    border-bottom: 1px solid var(--gray-200);
    padding-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    .data-row {
      grid-template-columns: 1fr;
      gap: 0.5rem;
    }

    .section-header {
      padding: 1rem 1.25rem;
    }

    .professional-card {
      margin-left: -1rem;
      margin-right: -1rem;
      border-radius: 0;
      border-left: none;
      border-right: none;
    }

    .coordinates-display {
      grid-template-columns: 1fr;
    }
  }

  /* Sender simplified form */
  .sender-simple-form .grid {
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  /* Toast messages */
  .toast-message {
    position: fixed;
    top: 1rem;
    right: 1rem;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  .toast-success {
    background-color: #10b981;
  }

  .toast-error {
    background-color: #ef4444;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style>

<div
  class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 professional-font py-8"
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header with Back Navigation -->
    <div class="mb-8">
      <a
        href="/admin/deliveries"
        class="inline-flex items-center text-primary-blue hover:text-primary-dark font-medium transition-colors duration-200"
      >
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"
          ></path>
        </svg>
        Back to Deliveries
      </a>
      <h1 class="text-2xl font-bold text-gray-900 mt-4">Create New Delivery</h1>
    </div>

    <!-- Main Form for Creating Delivery -->
    <form
      action="/admin/deliveries/create"
      method="POST"
      class="space-y-6"
      id="deliveryForm"
    >
      <!-- Main Card -->
      <div class="professional-card">
        <!-- Header Section -->
        <div class="section-header">
          <div
            class="flex flex-col sm:flex-row sm:items-center sm:justify-between"
          >
            <div class="mb-4 sm:mb-0">
              <h3 class="text-white text-xl font-semibold">
                Create New Delivery
              </h3>
              <p class="text-blue-100 mt-1 text-sm">
                Tracking ID will be generated automatically
              </p>
              <input type="hidden" name="trackingId" id="trackingId" />
            </div>
            <div class="flex items-center space-x-4">
              <select
                name="status"
                class="professional-select w-full bg-white/90 backdrop-blur-sm"
              >
                <option value="pending" selected>Pending</option>
                <option value="confirmed">Confirmed</option>
                <option value="picked_up">Picked Up</option>
                <option value="in_transit">In Transit</option>
                <option value="out_for_delivery">Out for Delivery</option>
                <option value="at_sort_facility">At Sort Facility</option>
              </select>
              <span class="status-badge status-pending">Pending</span>
            </div>
          </div>
        </div>

        <!-- Package Information -->
        <div class="data-grid">
          <div class="data-row">
            <dt class="data-label">Package Description *</dt>
            <dd class="data-value">
              <textarea
                name="package[description]"
                class="professional-textarea"
                required
                placeholder="Enter package description"
              ></textarea>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Category</dt>
            <dd class="data-value">
              <select name="package[category]" class="professional-select">
                <option value="documents">Documents</option>
                <option value="electronics">Electronics</option>
                <option value="clothing">Clothing</option>
                <option value="food">Food</option>
                <option value="medical">Medical</option>
                <option value="fragile" selected>Fragile</option>
                <option value="hazardous">Hazardous</option>
                <option value="other">Other</option>
              </select>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Weight (kg) *</dt>
            <dd class="data-value">
              <input
                type="number"
                name="package[weight]"
                class="professional-input"
                step="0.01"
                min="0.01"
                required
                placeholder="0.00"
              />
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Dimensions (cm) *</dt>
            <dd class="data-value flex space-x-2">
              <input
                type="number"
                name="package[dimensions][length]"
                class="professional-input w-1/3"
                min="1"
                placeholder="Length"
                required
              />
              <input
                type="number"
                name="package[dimensions][width]"
                class="professional-input w-1/3"
                min="1"
                placeholder="Width"
                required
              />
              <input
                type="number"
                name="package[dimensions][height]"
                class="professional-input w-1/3"
                min="1"
                placeholder="Height"
                required
              />
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Declared Value ($)</dt>
            <dd class="data-value">
              <input
                type="number"
                name="package[value]"
                class="professional-input"
                step="0.01"
                min="0"
                placeholder="0.00"
              />
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Insurance</dt>
            <dd class="data-value flex items-center space-x-4">
              <label class="flex items-center">
                <input
                  type="checkbox"
                  name="package[insurance]"
                  class="professional-checkbox mr-2"
                  id="insuranceCheckbox"
                />
                Insured
              </label>
              <div class="flex items-center space-x-2">
                <span class="text-sm text-gray-600">Value:</span>
                <input
                  type="number"
                  name="package[insuranceValue]"
                  id="insuranceValue"
                  class="professional-input w-32"
                  step="0.01"
                  min="0"
                  placeholder="Value ($)"
                  disabled
                  value="0"
                />
              </div>
            </dd>
          </div>
          <div class="data-row">
            <dt class="data-label">Package Flags</dt>
            <dd class="data-value flex flex-wrap gap-4">
              <label class="flex items-center package-flag flag-fragile">
                <input
                  type="checkbox"
                  name="package[fragile]"
                  class="professional-checkbox mr-2"
                />
                Fragile
              </label>
              <label class="flex items-center package-flag flag-perishable">
                <input
                  type="checkbox"
                  name="package[perishable]"
                  class="professional-checkbox mr-2"
                />
                Perishable
              </label>
              <label class="flex items-center package-flag flag-hazardous">
                <input
                  type="checkbox"
                  name="package[hazardous]"
                  class="professional-checkbox mr-2"
                />
                Hazardous
              </label>
            </dd>
          </div>
        </div>
      </div>

      <!-- Service & Timeline Information -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Service Details Card -->
        <div class="professional-card">
          <div class="section-header">
            <h3>Service Details</h3>
          </div>
          <div class="p-6 space-y-4">
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Service Type</span>
              <select name="serviceType" class="professional-select w-1/2">
                <option value="standard" selected>Standard</option>
                <option value="express">Express</option>
                <option value="overnight">Overnight</option>
                <option value="same_day">Same Day</option>
                <option value="international">International</option>
                <option value="freight">Freight</option>
              </select>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Priority</span>
              <select name="priority" class="professional-select w-1/2">
                <option value="low">Low</option>
                <option value="normal" selected>Normal</option>
                <option value="high">High</option>
                <option value="express">Express</option>
              </select>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Driver</span>
              <select name="driver" class="professional-select w-1/2">
                <option value="" selected>Unassigned</option>
                <% if (drivers && drivers.length > 0) { %> <%
                drivers.forEach(driver => { %>
                <option value="<%= driver._id %>">
                  <%= driver.name %> (<%= driver.phone %>)
                </option>
                <% }); %> <% } %>
              </select>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="data-label">Vehicle</span>
              <select name="vehicle" class="professional-select w-1/2">
                <option value="" selected>Unassigned</option>
                <% if (vehicles && vehicles.length > 0) { %> <%
                vehicles.forEach(vehicle => { %>
                <option value="<%= vehicle._id %>">
                  <%= vehicle.plateNumber %> (<%= vehicle.model %>)
                </option>
                <% }); %> <% } %>
              </select>
            </div>
          </div>
        </div>

        <!-- Timeline & Payment Information -->
        <div class="professional-card">
          <div class="section-header">
            <h3>Timeline & Payment</h3>
          </div>
          <div class="p-6 space-y-4">
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Estimated Delivery *</span>
              <input
                type="datetime-local"
                name="estimatedDelivery"
                class="professional-input w-1/2 date-input"
                required
              />
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Payment Method</span>
              <select name="payment[method]" class="professional-select w-1/2">
                <option value="prepaid" selected>Prepaid</option>
                <option value="cod">Cash on Delivery</option>
                <option value="credit">Credit</option>
                <option value="account">Account</option>
              </select>
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Amount ($)</span>
              <input
                type="number"
                name="payment[amount]"
                class="professional-input w-1/2"
                step="0.01"
                min="0"
                value="0"
              />
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Currency</span>
              <input
                type="text"
                name="payment[currency]"
                value="USD"
                class="professional-input w-1/2"
                maxlength="3"
                readonly
              />
            </div>
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Payment Status</span>
              <div class="flex items-center space-x-2">
                <select name="payment[paid]" class="professional-select w-1/2">
                  <option value="false" selected>Pending</option>
                  <option value="true">Paid</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sender & Recipient Information -->
      <div class="professional-card">
        <div class="section-header">
          <h3>Sender & Recipient Information</h3>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6">
          <!-- Sender - Simplified -->
          <div class="info-card sender-simple-form">
            <div class="info-card-header flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-primary-blue"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Sender Information
            </div>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600">Name *</label>
                <input
                  type="text"
                  name="sender[name]"
                  class="professional-input"
                  required
                  placeholder="John Doe"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600">Email *</label>
                <input
                  type="email"
                  name="sender[email]"
                  class="professional-input"
                  required
                  placeholder="john@example.com"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600">Phone *</label>
                <input
                  type="tel"
                  name="sender[phone]"
                  class="professional-input"
                  required
                  placeholder="+1234567890"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600">Address *</label>
                <textarea
                  name="sender[address][street]"
                  class="professional-textarea"
                  required
                  placeholder="123 Main St, City, State, ZIP Code"
                  rows="3"
                ></textarea>
              </div>
              <!-- Hidden coordinate inputs for sender -->
              <input type="hidden" name="sender[address][city]" value="City" />
              <input
                type="hidden"
                name="sender[address][state]"
                value="State"
              />
              <input
                type="hidden"
                name="sender[address][zipCode]"
                value="ZIP"
              />
              <input
                type="hidden"
                name="sender[address][country]"
                value="United States"
              />
              <input
                type="hidden"
                name="sender[address][coordinates][type]"
                value="Point"
              />
              <input
                type="hidden"
                name="sender[address][coordinates][coordinates][0]"
                id="sender-lng-input"
                value="0"
              />
              <input
                type="hidden"
                name="sender[address][coordinates][coordinates][1]"
                id="sender-lat-input"
                value="0"
              />
            </div>
          </div>

          <!-- Recipient - With Mapbox Geocoding -->
          <div class="info-card">
            <div class="info-card-header flex items-center">
              <svg
                class="w-5 h-5 mr-2 text-secondary-teal"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
              </svg>
              Recipient Information
            </div>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-600">Name *</label>
                <input
                  type="text"
                  name="receiver[name]"
                  class="professional-input"
                  required
                  placeholder="Jane Smith"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600">Email *</label>
                <input
                  type="email"
                  name="receiver[email]"
                  class="professional-input"
                  required
                  placeholder="jane@example.com"
                />
              </div>
              <div>
                <label class="text-sm text-gray-600">Phone *</label>
                <input
                  type="tel"
                  name="receiver[phone]"
                  class="professional-input"
                  required
                  placeholder="+1234567890"
                />
              </div>

              <!-- Address Search with Mapbox -->
              <div>
                <label class="text-sm text-gray-600">Search Address *</label>
                <div id="receiver-geocoder" class="mb-2"></div>
                <div class="geocoder-loading" id="receiver-loading">
                  <svg
                    class="animate-spin h-4 w-4 text-secondary-teal"
                    xmlns="http://www.w3.org/2000/svg"
                    fill="none"
                    viewBox="0 0 24 24"
                  >
                    <circle
                      class="opacity-25"
                      cx="12"
                      cy="12"
                      r="10"
                      stroke="currentColor"
                      stroke-width="4"
                    ></circle>
                    <path
                      class="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  <span>Geocoding address...</span>
                </div>
                <div class="geocoder-error" id="receiver-error">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path
                      fill-rule="evenodd"
                      d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                      clip-rule="evenodd"
                    />
                  </svg>
                  <span>Unable to geocode address. Please try again.</span>
                </div>
              </div>

              <!-- Address Fields (auto-filled by Mapbox) -->
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="text-sm text-gray-600">Street *</label>
                  <input
                    type="text"
                    name="receiver[address][street]"
                    id="receiver-street"
                    class="professional-input"
                    required
                    readonly
                  />
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-gray-600">City *</label>
                    <input
                      type="text"
                      name="receiver[address][city]"
                      id="receiver-city"
                      class="professional-input"
                      required
                      readonly
                    />
                  </div>
                  <div>
                    <label class="text-sm text-gray-600">State *</label>
                    <input
                      type="text"
                      name="receiver[address][state]"
                      id="receiver-state"
                      class="professional-input"
                      required
                      readonly
                    />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="text-sm text-gray-600">ZIP Code *</label>
                    <input
                      type="text"
                      name="receiver[address][zipCode]"
                      id="receiver-zip"
                      class="professional-input"
                      required
                      readonly
                    />
                  </div>
                  <div>
                    <label class="text-sm text-gray-600">Country *</label>
                    <input
                      type="text"
                      name="receiver[address][country]"
                      id="receiver-country"
                      value="United States"
                      class="professional-input"
                      required
                      readonly
                    />
                  </div>
                </div>
              </div>

              <!-- Coordinates (auto-filled by Mapbox) -->
              <div>
                <label class="text-sm text-gray-600 mb-1 block"
                  >Coordinates (auto-filled)</label
                >
                <input
                  type="hidden"
                  name="receiver[address][coordinates][type]"
                  value="Point"
                />
                <div class="coordinates-display">
                  <div class="coordinate-field">
                    <span class="coordinate-label">Longitude</span>
                    <div class="coordinate-value" id="receiver-longitude">
                      --
                    </div>
                    <input
                      type="hidden"
                      name="receiver[address][coordinates][coordinates][0]"
                      id="receiver-lng-input"
                    />
                  </div>
                  <div class="coordinate-field">
                    <span class="coordinate-label">Latitude</span>
                    <div class="coordinate-value" id="receiver-latitude">
                      --
                    </div>
                    <input
                      type="hidden"
                      name="receiver[address][coordinates][coordinates][1]"
                      id="receiver-lat-input"
                    />
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div class="flex items-center">
                  <label class="flex items-center text-sm text-gray-600">
                    <input
                      type="checkbox"
                      name="receiver[signatureRequired]"
                      class="professional-checkbox mr-2"
                      checked
                    />
                    Signature Required
                  </label>
                </div>
                <div class="flex items-center">
                  <label class="flex items-center text-sm text-gray-600">
                    <input
                      type="checkbox"
                      name="receiver[idVerificationRequired]"
                      class="professional-checkbox mr-2"
                    />
                    ID Verification
                  </label>
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-600"
                  >Delivery Instructions</label
                >
                <textarea
                  name="receiver[deliveryInstructions]"
                  class="professional-textarea"
                  placeholder="Special instructions for delivery..."
                ></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Map Preview -->
        <div class="p-6 border-t border-gray-200">
          <h4 class="text-sm font-medium text-gray-700 mb-4">Route Preview</h4>
          <div class="map-container" id="map"></div>
          <div class="mt-4 text-sm text-gray-600">
            <p>
              Enter recipient address to see route preview. Map will update
              automatically when address is selected.
            </p>
          </div>
        </div>
      </div>

      <!-- Additional Information -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Pickup Information -->
        <div class="professional-card">
          <div class="section-header">
            <h3>Pickup Information</h3>
          </div>
          <div class="p-6 space-y-4">
            <div
              class="flex justify-between items-center py-2 border-b border-gray-100"
            >
              <span class="data-label">Scheduled Pickup</span>
              <input
                type="datetime-local"
                name="pickup[scheduledDate]"
                class="professional-input w-1/2 date-input"
              />
            </div>
            <div>
              <label class="text-sm text-gray-600">Pickup Notes</label>
              <textarea
                name="pickup[notes]"
                class="professional-textarea"
                placeholder="Any special pickup instructions..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Notes -->
        <div class="professional-card">
          <div class="section-header">
            <h3>Notes</h3>
          </div>
          <div class="p-6 space-y-4">
            <div>
              <label class="text-sm text-gray-600">Public Notes</label>
              <textarea
                name="notes"
                class="professional-textarea"
                placeholder="Notes visible to customer..."
              ></textarea>
            </div>
            <div>
              <label class="text-sm text-gray-600">Internal Notes</label>
              <textarea
                name="internalNotes"
                class="professional-textarea"
                placeholder="Internal notes for admin use only..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Buttons -->
      <div class="flex justify-end space-x-4 mt-8">
        <button
          type="button"
          class="btn-secondary"
          onclick="window.history.back()"
        >
          Cancel
        </button>
        <button type="submit" class="btn-primary">Create Delivery</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Mapbox access token
  mapboxgl.accessToken =
    "<%= process.env.MAPBOX_ACCESS_TOKEN || 'YOUR_MAPBOX_ACCESS_TOKEN' %>";

  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("deliveryForm");
    let map = null;
    let routeLayer = null;
    let senderCoordinates = [-98.5795, 39.8283]; // Default center of US
    let receiverCoordinates = null;

    // Initialize Map
    function initMap() {
      if (
        !mapboxgl.accessToken ||
        mapboxgl.accessToken === "YOUR_MAPBOX_ACCESS_TOKEN"
      ) {
        console.warn("Mapbox access token not configured");
        showToast(
          "Mapbox access token not configured. Map features disabled.",
          "error"
        );
        return;
      }

      try {
        map = new mapboxgl.Map({
          container: "map",
          style: "mapbox://styles/mapbox/streets-v11",
          center: senderCoordinates,
          zoom: 3,
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());

        // Add a default marker for sender
        new mapboxgl.Marker({ color: "#2563eb" })
          .setLngLat(senderCoordinates)
          .setPopup(
            new mapboxgl.Popup().setHTML(
              "<h3>Sender Location</h3><p>Default location</p>"
            )
          )
          .addTo(map);
      } catch (error) {
        console.error("Error initializing map:", error);
        showToast("Failed to initialize map", "error");
      }
    }

    // Initialize Mapbox Geocoder for receiver
    function initGeocoder() {
      if (
        !mapboxgl.accessToken ||
        mapboxgl.accessToken === "YOUR_MAPBOX_ACCESS_TOKEN"
      ) {
        console.warn("Mapbox access token not configured - geocoding disabled");
        return;
      }

      // Receiver Geocoder
      const receiverGeocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        types: "address",
        countries: "us",
        placeholder: "Search recipient address...",
        bbox: [-125.0, 24.0, -66.0, 50.0], // Continental US bounds
        proximity: { longitude: -98.5795, latitude: 39.8283 },
      });

      // Add geocoder to DOM
      document
        .getElementById("receiver-geocoder")
        .appendChild(receiverGeocoder.onAdd());

      // Receiver Geocoder event handlers
      receiverGeocoder.on("result", async (e) => {
        const result = e.result;
        await processGeocodeResult(result);
      });

      receiverGeocoder.on("loading", () => {
        document.getElementById("receiver-loading").classList.add("active");
        document.getElementById("receiver-error").classList.remove("active");
      });

      receiverGeocoder.on("results", () => {
        document.getElementById("receiver-loading").classList.remove("active");
      });

      receiverGeocoder.on("error", () => {
        document.getElementById("receiver-loading").classList.remove("active");
        document.getElementById("receiver-error").classList.add("active");
        showToast("Failed to geocode address", "error");
      });
    }

    // Process geocode result and fill form fields
    async function processGeocodeResult(result) {
      const coordinates = result.geometry.coordinates;
      const [lng, lat] = coordinates;

      // Extract address components
      const address = extractAddressComponents(result);

      // Update form fields
      updateAddressFields(address, coordinates);

      // Show success message
      showGeocodeSuccess();

      // Update map with receiver location
      receiverCoordinates = coordinates;
      updateRouteMap();
    }

    // Extract address components from Mapbox result
    function extractAddressComponents(result) {
      const context = result.context || [];
      const address = {
        street: result.text || "",
        city: "",
        state: "",
        zipCode: "",
        country: "United States",
      };

      // Parse context to get city, state, zip
      context.forEach((item) => {
        const idParts = item.id.split(".");
        if (idParts.length > 1) {
          const type = idParts[0];
          if (type === "place") {
            address.city = item.text;
          } else if (type === "region") {
            address.state = item.text;
          } else if (type === "postcode") {
            address.zipCode = item.text;
          } else if (type === "country") {
            address.country = item.text;
          }
        }
      });

      // If street address is in properties, use it
      if (result.properties && result.properties.address) {
        address.street = `${result.properties.address} ${address.street}`;
      }

      return address;
    }

    // Update address fields in the form
    function updateAddressFields(address, coordinates) {
      // Update street
      document.getElementById("receiver-street").value = address.street;

      // Update city
      document.getElementById("receiver-city").value = address.city;

      // Update state
      document.getElementById("receiver-state").value = address.state;

      // Update zip code
      document.getElementById("receiver-zip").value = address.zipCode;

      // Update country
      document.getElementById("receiver-country").value = address.country;

      // Update coordinates display and hidden inputs
      const lngDisplay = document.getElementById("receiver-longitude");
      const latDisplay = document.getElementById("receiver-latitude");
      const lngInput = document.getElementById("receiver-lng-input");
      const latInput = document.getElementById("receiver-lat-input");

      lngDisplay.textContent = coordinates[0].toFixed(6);
      latDisplay.textContent = coordinates[1].toFixed(6);
      lngInput.value = coordinates[0];
      latInput.value = coordinates[1];
    }

    // Show geocode success message
    function showGeocodeSuccess() {
      const loadingEl = document.getElementById("receiver-loading");

      // Briefly show success state
      loadingEl.innerHTML = `
        <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
        </svg>
        <span class="text-green-600">Address geocoded successfully!</span>
      `;
      loadingEl.classList.add("active");

      // Remove success message after 2 seconds
      setTimeout(() => {
        loadingEl.classList.remove("active");
        loadingEl.innerHTML = `
          <svg class="animate-spin h-4 w-4 text-secondary-teal" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Geocoding address...</span>
        `;
      }, 2000);
    }

    // Update route on map
    function updateRouteMap() {
      if (!map || !receiverCoordinates) return;

      // Clear existing markers and route
      const markers = document.querySelectorAll(".mapboxgl-marker");
      markers.forEach((marker) => marker.remove());

      if (routeLayer) {
        if (map.getLayer("route")) map.removeLayer("route");
        if (map.getSource("route")) map.removeSource("route");
      }

      // Add receiver marker
      new mapboxgl.Marker({ color: "#0d9488" })
        .setLngLat(receiverCoordinates)
        .setPopup(new mapboxgl.Popup().setHTML("<h3>Recipient</h3>"))
        .addTo(map);

      // Calculate bounds
      const bounds = new mapboxgl.LngLatBounds()
        .extend(senderCoordinates)
        .extend(receiverCoordinates);

      map.fitBounds(bounds, { padding: 50 });

      // Get route from Mapbox Directions API
      getRoute(senderCoordinates, receiverCoordinates);
    }

    // Get route from Mapbox Directions API
    async function getRoute(start, end) {
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`;

      try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.routes && data.routes[0]) {
          const route = data.routes[0].geometry;

          // Add route layer to map
          if (map.getSource("route")) {
            map.getSource("route").setData(route);
          } else {
            map.addLayer({
              id: "route",
              type: "line",
              source: {
                type: "geojson",
                data: route,
              },
              layout: {
                "line-join": "round",
                "line-cap": "round",
              },
              paint: {
                "line-color": "#2563eb",
                "line-width": 4,
                "line-opacity": 0.7,
              },
            });
          }

          routeLayer = route;
        }
      } catch (error) {
        console.error("Error fetching route:", error);
      }
    }

    // Form validation
    function setupFormValidation() {
      const form = document.getElementById("deliveryForm");

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        // Validate required fields
        const requiredFields = form.querySelectorAll("[required]");
        let isValid = true;

        requiredFields.forEach((field) => {
          if (!field.value.trim()) {
            isValid = false;
            field.classList.add("border-red-500");
            showFieldError(field, "This field is required");
          } else {
            field.classList.remove("border-red-500");
            clearFieldError(field);
          }
        });

        // Validate coordinates
        const receiverLng = document.getElementById("receiver-lng-input").value;
        const receiverLat = document.getElementById("receiver-lat-input").value;

        if (
          !receiverLng ||
          !receiverLat ||
          receiverLng === "0" ||
          receiverLat === "0"
        ) {
          isValid = false;
          showToast(
            "Please select a valid recipient address using the search box",
            "error"
          );
        }

        // Validate numeric fields
        const weightInput = form.querySelector('input[name="package[weight]"]');
        if (weightInput && parseFloat(weightInput.value) <= 0) {
          isValid = false;
          showFieldError(weightInput, "Weight must be greater than 0");
        }

        if (isValid) {
          // Generate tracking ID if not already set
          if (!document.getElementById("trackingId").value) {
            document.getElementById("trackingId").value = generateTrackingId();
          }

          // Show loading state
          const submitBtn = form.querySelector('button[type="submit"]');
          submitBtn.innerHTML = "Creating Delivery...";
          submitBtn.disabled = true;

          // Submit form
          form.submit();
        } else {
          showToast("Please fill in all required fields correctly", "error");
        }
      });
    }

    // Generate tracking ID
    function generateTrackingId() {
      const prefix = "DEL";
      const timestamp = Date.now().toString(36).toUpperCase();
      const random = Math.random().toString(36).substring(2, 6).toUpperCase();
      return `${prefix}${timestamp}${random}`;
    }

    // Show field error
    function showFieldError(field, message) {
      clearFieldError(field);

      const errorDiv = document.createElement("div");
      errorDiv.className = "text-red-500 text-xs mt-1";
      errorDiv.textContent = message;

      field.parentNode.appendChild(errorDiv);
    }

    // Clear field error
    function clearFieldError(field) {
      const existingError = field.parentNode.querySelector(".text-red-500");
      if (existingError) {
        existingError.remove();
      }
    }

    // Show toast message
    function showToast(message, type = "error") {
      // Remove existing toast
      const existingToast = document.querySelector(".toast-message");
      if (existingToast) {
        existingToast.remove();
      }

      // Create toast
      const toast = document.createElement("div");
      toast.className = `toast-message ${
        type === "success" ? "toast-success" : "toast-error"
      }`;
      toast.textContent = message;

      document.body.appendChild(toast);

      // Remove toast after 5 seconds
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    // Toggle insurance value field
    const insuranceCheckbox = document.getElementById("insuranceCheckbox");
    const insuranceValueInput = document.getElementById("insuranceValue");

    if (insuranceCheckbox && insuranceValueInput) {
      insuranceCheckbox.addEventListener("change", function () {
        insuranceValueInput.disabled = !this.checked;
        if (!this.checked) {
          insuranceValueInput.value = "0";
        }
      });
    }

    // Initialize date inputs with tomorrow's date
    function initializeDateInputs() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);

      const dateInputs = document.querySelectorAll(
        'input[type="datetime-local"]'
      );
      dateInputs.forEach((input) => {
        if (!input.value) {
          input.value = tomorrow.toISOString().slice(0, 16);
        }
      });
    }

    // Initialize everything
    function init() {
      initMap();
      initGeocoder();
      setupFormValidation();
      initializeDateInputs();
    }

    // Start initialization
    init();
  });
</script>
