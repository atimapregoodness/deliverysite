<%- layout('layouts/admin') %>

<style>
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .status-active { background: #dcfce7; color: #16a34a; }
  .status-inactive { background: #f3f4f6; color: #374151; }
  .status-on_delivery { background: #dbeafe; color: #1e40af; }
  .status-on_break { background: #fef3c7; color: #d97706; }
  .status-off_duty { background: #f3f4f6; color: #6b7280; }

  .online-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
  }

  .online-true { background: #10b981; }
  .online-false { background: #ef4444; }

  /* Delete button styles */
  .delete-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 0.5rem;
  }


  .delete-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #9ca3af !important;
}

.delete-btn.disabled:hover {
  background: #9ca3af !important;
  transform: none;
}
  .delete-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
  }

  .delete-btn i {
    margin-right: 0.25rem;
  }

  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 400px;
    width: 90%;
  }

  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .btn-cancel {
    background: #6b7280;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
  }

  .btn-confirm-delete {
    background: #ef4444;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
  }

  /* Actions container */
  .actions-container {
    display: flex;
    gap: 0.5rem;
  }
</style>

<div class="min-h-screen bg-gray-50">
  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete Driver</h3>
      <p class="text-gray-600 mb-4">Are you sure you want to delete this driver? This action cannot be undone.</p>
      <div class="modal-actions">
        <button type="button" id="cancelDelete" class="btn-cancel">Cancel</button>
        <button type="button" id="confirmDelete" class="btn-confirm-delete">
          <i class="fas fa-trash mr-2"></i>Delete
        </button>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Manage Drivers</h1>
          <p class="mt-2 text-gray-600">View and manage all delivery drivers</p>
        </div>
        <a href="/admin/drivers/new" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">
          <i class="fas fa-plus mr-2"></i>Add Driver
        </a>
      </div>

      <!-- Stats Overview -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="p-2 bg-blue-100 rounded-lg">
              <i class="fas fa-users text-blue-600"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Total Drivers</p>
              <p class="text-2xl font-bold text-gray-900"><%= drivers.length %></p>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="p-2 bg-green-100 rounded-lg">
              <i class="fas fa-check-circle text-green-600"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Available Drivers</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= drivers.filter(d => d.status === 'available').length %>
              </p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="p-2 bg-yellow-100 rounded-lg">
              <i class="fas fa-truck text-yellow-600"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">On Delivery</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= drivers.filter(d => d.status === 'on_delivery').length %>
              </p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4">
          <div class="flex items-center">
            <div class="p-2 bg-purple-100 rounded-lg">
              <i class="fas fa-box text-purple-600"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Active Deliveries</p>
              <p class="text-2xl font-bold text-gray-900">
                <%= drivers.reduce((total, d) => total + (d.currentDeliveries ? d.currentDeliveries.length : 0), 0) %>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="bg-white shadow rounded-lg p-4 mb-6">
        <form method="GET" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
          <div class="flex-1">
            <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
            <input type="text" name="search" id="search" value="<%= query.search || '' %>" 
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                placeholder="Search by name, email, or license...">
          </div>
          <div>
            <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
            <select id="status" name="status" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
              <option value="">All Statuses</option>
              <option value="available" <%= query.status === 'available' ? 'selected' : '' %>>Available</option>
              <option value="on_delivery" <%= query.status === 'on_delivery' ? 'selected' : '' %>>On Delivery</option>
              <option value="off_duty" <%= query.status === 'off_duty' ? 'selected' : '' %>>Off Duty</option>
              <option value="break" <%= query.status === 'break' ? 'selected' : '' %>>On Break</option>
            </select>
          </div>
          <div class="flex items-end">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-150 ease-in-out">
              <i class="fas fa-filter mr-2"></i>Filter
            </button>
            <% if (query.search || query.status) { %>
              <a href="/admin/drivers" class="ml-2 bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition duration-150 ease-in-out">
                Clear
              </a>
            <% } %>
          </div>
        </form>
      </div>

      <!-- Drivers Table -->
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <% if (drivers && drivers.length > 0) { %>
          <ul class="divide-y divide-gray-200">
            <% drivers.forEach(driver => { %>
              <li class="hover:bg-gray-50" id="driver-<%= driver._id %>">
                <div class="px-4 py-4 flex items-center sm:px-6">
                  <div class="min-w-0 flex-1 sm:flex sm:items-center sm:justify-between">
                    <div class="flex-1">
                      <div class="flex items-center justify-between">
                        <div class="flex items-center">
                          <div class="flex-shrink-0">
                            <% if (driver.photo) { %>
                              <img class="h-12 w-12 rounded-full object-cover" src="<%= driver.photo %>" alt="<%= driver.name %>">
                            <% } else { %>
                              <div class="h-12 w-12 bg-blue-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-semibold text-sm">
                                  <%= driver.name.charAt(0).toUpperCase() %>
                                </span>
                              </div>
                            <% } %>
                          </div>
                          <div class="ml-4">
                            <div class="flex items-center">
                              <p class="text-sm font-medium text-gray-900"><%= driver.name %></p>
                              <span class="ml-2 status-badge status-<%= driver.status %>">
                                <%= driver.status.replace('_', ' ').toUpperCase() %>
                              </span>
                            </div>
                            <div class="mt-1 flex flex-col sm:flex-row sm:flex-wrap sm:space-x-4">
                              <div class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-envelope mr-1.5"></i>
                                <p><%= driver.email %></p>
                              </div>
                              <div class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-phone mr-1.5"></i>
                                <p><%= driver.phone %></p>
                              </div>
                              <% if (driver.licenseNumber) { %>
                                <div class="flex items-center text-sm text-gray-500">
                                  <i class="fas fa-id-card mr-1.5"></i>
                                  <p><%= driver.licenseNumber %></p>
                                </div>
                              <% } %>
                            </div>
                          </div>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                          <div class="flex items-center">
                            <div class="flex items-center text-sm text-gray-500 mr-4">
                              <i class="fas fa-star text-yellow-400 mr-1"></i>
                              <span><%= driver.rating || 4.5 %>/5.0</span>
                            </div>
                            <div class="flex items-center text-sm text-gray-500">
                              <i class="fas fa-box mr-1.5"></i>
                              <p><%= driver.stats ? driver.stats.totalDeliveries : 0 %> deliveries</p>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="mt-2 flex items-center justify-between">
                        <div class="flex items-center text-sm text-gray-500">
                          <i class="fas fa-map-marker-alt mr-1.5"></i>
                          <p>
                            <% if (driver.currentLocation && driver.currentLocation.coordinates[0] !== 0) { %>
                              Location: <%= driver.currentLocation.coordinates[1].toFixed(4) %>°N, <%= driver.currentLocation.coordinates[0].toFixed(4) %>°E
                            <% } else { %>
                              Location not set
                            <% } %>
                          </p>
                        </div>
                        <div class="actions-container">
                          <a href="/admin/drivers/<%= driver._id %>/edit" class="bg-blue-100 text-blue-600 px-3 py-1 rounded-md text-sm hover:bg-blue-200 transition">
                            <i class="fas fa-edit mr-1"></i>Edit
                          </a>
                          <a href="/admin/drivers/<%= driver._id %>" class="bg-green-100 text-green-600 px-3 py-1 rounded-md text-sm hover:bg-green-200 transition">
                            <i class="fas fa-eye mr-1"></i>View
                          </a>
<!-- In the drivers list, update the delete button section -->
<% 
  // Check if driver can be deleted
  const canDeleteDriver = !driver.currentDeliveries || driver.currentDeliveries.length === 0;
  const deleteTooltip = canDeleteDriver ? 'Delete driver' : 'Cannot delete driver with active deliveries';
%>

<button type="button" 
        class="delete-btn <%= canDeleteDriver ? '' : 'disabled' %>" 
        <%= canDeleteDriver ? '' : 'disabled' %>
        title="<%= deleteTooltip %>"
        data-driver-id="<%= driver._id %>" 
        data-driver-name="<%= driver.name %>">
  <i class="fas fa-trash"></i>Delete
</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </li>
            <% }); %>
          </ul>
        <% } else { %>
          <div class="text-center py-12">
            <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">No drivers found</h3>
            <p class="mt-2 text-sm text-gray-500">
              <% if (query.search || query.status) { %>
                Try adjusting your search or filter to find what you're looking for.
              <% } else { %>
                Get started by adding your first driver.
              <% } %>
            </p>
            <div class="mt-6">
              <a href="/admin/drivers/new" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                <i class="fas fa-plus mr-2"></i>Add Driver
              </a>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const deleteModal = document.getElementById('deleteModal');
    const cancelDeleteBtn = document.getElementById('cancelDelete');
    const confirmDeleteBtn = document.getElementById('confirmDelete');
    let driverToDelete = null;
    let driverName = '';

    // Open delete modal
    document.querySelectorAll('.delete-btn:not(.disabled)').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        driverToDelete = this.getAttribute('data-driver-id');
        driverName = this.getAttribute('data-driver-name');
        
        // Update modal message
        document.querySelector('#deleteModal p').textContent = 
          `Are you sure you want to delete driver "${driverName}"? This action cannot be undone.`;
        
        // Show modal
        deleteModal.style.display = 'flex';
      });
    });

    // Close modal on cancel
    cancelDeleteBtn.addEventListener('click', function() {
      deleteModal.style.display = 'none';
      driverToDelete = null;
      driverName = '';
    });

    // Close modal on background click
    deleteModal.addEventListener('click', function(e) {
      if (e.target === deleteModal) {
        deleteModal.style.display = 'none';
        driverToDelete = null;
        driverName = '';
      }
    });

    // Handle delete confirmation
    confirmDeleteBtn.addEventListener('click', async function() {
      if (!driverToDelete) return;

      // Disable button and show loading
      this.disabled = true;
      this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';

      try {
        const response = await fetch(`/admin/drivers/${driverToDelete}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          }
        });

        const result = await response.json();

        if (response.ok && result.success) {
          // Remove the driver row from the table
          const driverRow = document.getElementById(`driver-${driverToDelete}`);
          if (driverRow) {
            driverRow.remove();
          }
          
          // Update stats
          updateStatsAfterDeletion();
          
          // Show success message
          showNotification(result.message || 'Driver deleted successfully', 'success');
        } else {
          // Show error message
          showNotification(result.error || 'Failed to delete driver', 'error');
        }
      } catch (error) {
        console.error('Error deleting driver:', error);
        showNotification('Error deleting driver. Please try again.', 'error');
      } finally {
        // Reset button state
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-trash mr-2"></i>Delete';
        
        // Close modal
        deleteModal.style.display = 'none';
        driverToDelete = null;
        driverName = '';
      }
    });

    // Function to show notification
    function showNotification(message, type) {
      // Remove existing notifications
      const existingNotifications = document.querySelectorAll('.notification');
      existingNotifications.forEach(notification => notification.remove());

      // Create notification element
      const notification = document.createElement('div');
      notification.className = `notification fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 
        'bg-red-100 text-red-800 border border-red-200'
      }`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
          <span>${message}</span>
        </div>
      `;

      // Add to page
      document.body.appendChild(notification);

      // Remove after 5 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }

    // Update stats after deletion
    function updateStatsAfterDeletion() {
      // Update total drivers count
      const totalDriversElement = document.querySelector('.bg-white.rounded-lg.shadow.p-4:nth-child(1) .text-2xl');
      if (totalDriversElement) {
        const currentCount = parseInt(totalDriversElement.textContent);
        totalDriversElement.textContent = Math.max(0, currentCount - 1);
      }

      // You can update other stats similarly
      // Or reload the page to get fresh stats
      // window.location.reload();
    }

    // Add keyboard support for modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && deleteModal.style.display === 'flex') {
        deleteModal.style.display = 'none';
        driverToDelete = null;
        driverName = '';
      }
    });
  });
</script>